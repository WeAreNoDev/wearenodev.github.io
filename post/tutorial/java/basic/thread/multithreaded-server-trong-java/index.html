<!doctype html><html class=no-js lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#ffffff"><title>Multithreaded Server trong Java - We Are No Dev</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content="B√†i vi·∫øt n√†y gi·ªõi thi·ªáu v·ªÅ multithreaded server trong Java, n·∫±m trong chu·ªói b√†i vi·∫øt v·ªÅ c√°c ki·ªÉu thi·∫øt k·∫ø ƒëa lu·ªìng cho server trong Java. M·ªói ki·ªÉu thi·∫øt k·∫ø s·∫Ω c√≥ ∆∞u v√† nh∆∞·ª£c ƒëi·ªÉm ri√™ng c·ªßa n√≥."><meta property="og:title" content="Multithreaded Server trong Java"><meta property="og:description" content="B√†i vi·∫øt n√†y gi·ªõi thi·ªáu v·ªÅ multithreaded server trong Java, n·∫±m trong chu·ªói b√†i vi·∫øt v·ªÅ c√°c ki·ªÉu thi·∫øt k·∫ø ƒëa lu·ªìng cho server trong Java. M·ªói ki·ªÉu thi·∫øt k·∫ø s·∫Ω c√≥ ∆∞u v√† nh∆∞·ª£c ƒëi·ªÉm ri√™ng c·ªßa n√≥."><meta property="og:type" content="article"><meta property="og:url" content="/post/tutorial/java/basic/thread/multithreaded-server-trong-java/"><meta property="article:published_time" content="2019-08-18T00:00:00+00:00"><meta property="article:modified_time" content="2019-08-18T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Multithreaded Server trong Java"><meta name=twitter:description content="B√†i vi·∫øt n√†y gi·ªõi thi·ªáu v·ªÅ multithreaded server trong Java, n·∫±m trong chu·ªói b√†i vi·∫øt v·ªÅ c√°c ki·ªÉu thi·∫øt k·∫ø ƒëa lu·ªìng cho server trong Java. M·ªói ki·ªÉu thi·∫øt k·∫ø s·∫Ω c√≥ ∆∞u v√† nh∆∞·ª£c ƒëi·ªÉm ri√™ng c·ªßa n√≥."><link rel=icon type=image/png href=/favicon.png><link rel=apple-touch-icon href=/favicon.png><meta name=msapplication-TileImage content="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Muli:ital,wght@0,400;0,500;0,700;0,800;1,400&display=swap" rel=stylesheet><link href=//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css rel=stylesheet integrity=sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1 crossorigin=anonymous><link rel=stylesheet href=/css/style.min.a36eb9154ee93249b89e9a2f0e2fead7.css integrity="md5-o265FU7pMkm4npovDi/q1w=="><link rel=stylesheet href=/css/spacing_helpers.min.css><link rel=stylesheet href=/css/custom.css></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class=logo><a href=/ title="We Are No Dev" rel=home><img src=/favicon.png alt="We Are No Dev" class=header__favicon></a>
<a class=logo__link href=/ title="We Are No Dev" rel=home><div class=logo__title>We Are No Dev</div><div class=logo__tagline>We are NOT ONLY Developers</div></a><img src=/img/fill-banner.png alt="We Are No Dev" class=header__banner_img></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Multithreaded Server trong Java</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2019-08-18T00:00:00Z>Aug 18, 2019</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/java-tutorial/ rel=category>Java Tutorial</a></span></div></div></header><div class="post__toc toc toc_mobile"><div class=toc__title>Table of contents</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#multithreaded-server>Multithreaded server</a></li><li><a href=#hi·ªán-th·ª±c-m·ªôt-multithreaded-server>Hi·ªán th·ª±c m·ªôt multithreaded server</a></li></ul></nav></div></div><div class="content post__content clearfix"><p><strong>Multithreaded server</strong> hay <strong>server ƒëa lu·ªìng</strong> l√† ki·ªÉu thi·∫øt k·∫ø server s·ª≠ d·ª•ng lu·ªìng ch√≠nh ƒë·ªÉ nh·∫≠n request t·ª´ client v√† s·ª≠ d·ª•ng c√°c worker thread ƒë·ªÉ x·ª≠ l√Ω c√°c request. ƒê·ªÉ ph√¢n bi·ªát c√°c ki·ªÉu server n√†y, c√°c b·∫°n c√≥ th·ªÉ quay v·ªÅ b√†i vi·∫øt tr∆∞·ªõc t·∫°i ƒë√¢y. B√†i vi·∫øt n√†y s·∫Ω gi·ªõi thi·ªáu v·ªÅ c√°ch hi·ªán th·ª±c m·ªôt server ƒëa lu·ªìng ƒë∆°n gi·∫£n trong Java.</p><h2 id=multithreaded-server>Multithreaded server</h2><p><strong>Server ƒëa lu·ªìng</strong> l√† m·ªôt thi·∫øt k·∫ø server s·ª≠ d·ª•ng c√°c worker thread ƒë·ªÉ x·ª≠ l√Ω request t·ª´ client, kh√°c v·ªõi <a href=/post/tutorial/java/basic/thread/singlethreaded-server-trong-java/>singlethreaded server</a> khi singlethreaded s·ª≠ d·ª•ng ch√≠nh thread nh·∫≠n request ƒë·ªÉ handle c√°c connection, khi·∫øn server b·ªã blocked trong kho·∫£ng th·ªùi gian x·ª≠ l√Ω.</p><p>Nh∆∞ trong h√¨nh d∆∞·ªõi ƒë√¢y, v·ªõi m·ªói client connect ƒë·∫øn server, server th·ª±c hi·ªán forward connection ƒë√≥ sang m·ªôt thread m·ªõi ƒë·ªÉ x·ª≠ l√Ω, tr√°nh vi·ªác b·ªã block tr√™n thread ch√≠nh c·ªßa server.</p><div class="center m-t-20 m-b-20"><img src=/img/post/java/thread/multithreaded-server.jpg alt=MultiThreadedServer width=80% decoding=async></div><h2 id=hi·ªán-th·ª±c-m·ªôt-multithreaded-server>Hi·ªán th·ª±c m·ªôt multithreaded server</h2><p>Vi·ªác hi·ªán th·ª±c multithreaded server ƒë∆∞·ª£c d·ª±a tr√™n <a href=/post/tutorial/java/basic/thread/singlethreaded-server-trong-java/>singlethreaded server</a> ƒë√£ ƒë∆∞·ª£c tr√¨nh b√†y trong b√†i vi·∫øt tr∆∞·ªõc, ƒëi·ªÅu kh√°c bi·ªát gi·ªØa 2 c√°ch hi·ªán th·ª±c ch√≠nh l√† thay v√¨ th·ª±c hi·ªán x·ª≠ l√Ω request t·ª´ client ngay tr√™n thread ch√≠nh, ta t·∫°o m·ªôt thread m·ªõi ƒë·ªÉ th·ª±c hi·ªán handle connection ƒë√≥, g·ªçi l√† <code>worker thread</code>. Nh·ªù s·ª≠ d·ª•ng m·ªôt thread m·ªõi gi√∫p cho server tr√°nh b·ªã block t·∫°i th·ªùi ƒëi·ªÉm ƒë√≥. Tuy nhi√™n khi l∆∞·ª£ng connection ƒë·∫øn qu√° nhi·ªÅu, vi·ªác t·∫°o li√™n t·ª•c c√°c thread m·ªõi nh∆∞ v·∫≠y c≈©ng s·∫Ω c√≥ nh·ªØng khuy·∫øt ƒëi·ªÉm nh·∫•t ƒë·ªãnh, do ƒë√≥ ta c√≥ th√™m m·ªôt c√°ch thi·∫øt k·∫ø cho multithreaded ch√≠nh l√† <a href=/post/tutorial/java/basic/thread/thread-pooled-server-trong-java/>threadpooled server</a>.</p><p>D∆∞·ªõi ƒë√¢y l√† m·ªôt hi·ªán th·ª±c ƒë∆°n gi·∫£n cho multithreaded server, xem <a href=https://github.com/wearenodev/java-examples/blob/master/src/wearenodev/java/examples/thread/MultiThreadedServer.java>m√£ ngu·ªìn v√≠ d·ª• t·∫°i ƒë√¢y</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/*
</span><span style=color:#75715e> * License from https://github.com/wearenodev
</span><span style=color:#75715e> */</span>
<span style=color:#f92672>package</span> wearenodev.java.examples.thread<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> java.io.IOException<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.io.InputStream<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.io.OutputStream<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.net.ServerSocket<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.net.Socket<span style=color:#f92672>;</span>

<span style=color:#75715e>/**
</span><span style=color:#75715e> *
</span><span style=color:#75715e> * @author harisk
</span><span style=color:#75715e> */</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MultiThreadedServer</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>

    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * Worker Thread
</span><span style=color:#75715e>     */</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RunnableWorker</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>

        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Socket clientSocket<span style=color:#f92672>;</span>

        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RunnableWorker</span><span style=color:#f92672>(</span>Socket clientSocket<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>clientSocket</span> <span style=color:#f92672>=</span> clientSocket<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>

        <span style=color:#a6e22e>@Override</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                InputStream input <span style=color:#f92672>=</span> clientSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>();</span>
                OutputStream output <span style=color:#f92672>=</span> clientSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>getOutputStream</span><span style=color:#f92672>();</span>

                <span style=color:#66d9ef>long</span> time <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> responseDocument <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&lt;html&gt;&lt;body&gt;&#34;</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;SingleThreadedServer time: &#34;</span>
                        <span style=color:#f92672>+</span> time
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/body&gt;&lt;/html&gt;&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>);</span>

                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> responseHeader <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;HTTP/1.1 200 OK\r\n&#34;</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Content-Type: text/html; charset=UTF-8\r\n&#34;</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Content-Length: &#34;</span> <span style=color:#f92672>+</span> responseDocument<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\r\n\r\n&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>);</span>

                output<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>responseHeader<span style=color:#f92672>);</span>
                output<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>responseDocument<span style=color:#f92672>);</span>

                output<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
                input<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>

                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Request processed: &#34;</span> <span style=color:#f92672>+</span> time<span style=color:#f92672>);</span>

            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> serverPort<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> ServerSocket serverSocket<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> isStopped <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MultiThreadedServer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> port<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverPort</span> <span style=color:#f92672>=</span> port<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isStopped</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isStopped</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stop</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isStopped</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverSocket</span><span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>

        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Error on stop server&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>openServerSocket</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverSocket</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServerSocket<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverPort</span><span style=color:#f92672>);</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Server is running on port &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverPort</span><span style=color:#f92672>);</span>

        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cannot open port &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverPort</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>

        openServerSocket<span style=color:#f92672>();</span>

        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>isStopped<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            Socket clientSocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                clientSocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverSocket</span><span style=color:#f92672>.</span><span style=color:#a6e22e>accept</span><span style=color:#f92672>();</span>

            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isStopped<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Server stopped&#34;</span><span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span>
                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Error on accept client connection&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>

            <span style=color:#f92672>}</span>
            <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> RunnableWorker<span style=color:#f92672>(</span>clientSocket<span style=color:#f92672>)).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Server stopped&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>

        MultiThreadedServer server <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MultiThreadedServer<span style=color:#f92672>(</span>8080<span style=color:#f92672>);</span>

        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * Run server in single thread
</span><span style=color:#75715e>         */</span>
        <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span>server<span style=color:#f92672>).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>

        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * Waiting 20s before stopping server
</span><span style=color:#75715e>         */</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>20 <span style=color:#f92672>*</span> 1000<span style=color:#f92672>);</span>

        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            ex<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>

        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * Stop server and exit processR
</span><span style=color:#75715e>         */</span>
        server<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>exit</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Trong v√≠ d·ª• tr√™n, ta ƒë·ªãnh nghƒ©a c√°c <code>worker thread</code> b·∫±ng m·ªôt subclass <code>RunnableWorker</code> hi·ªán th·ª±c interface <code>Runnaable</code> nh∆∞ sau:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/// ...
</span><span style=color:#75715e></span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RunnableWorker</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>

        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Socket clientSocket<span style=color:#f92672>;</span>

        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RunnableWorker</span><span style=color:#f92672>(</span>Socket clientSocket<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>clientSocket</span> <span style=color:#f92672>=</span> clientSocket<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>

        <span style=color:#a6e22e>@Override</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                InputStream input <span style=color:#f92672>=</span> clientSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>();</span>
                OutputStream output <span style=color:#f92672>=</span> clientSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>getOutputStream</span><span style=color:#f92672>();</span>

                <span style=color:#66d9ef>long</span> time <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> responseDocument <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&lt;html&gt;&lt;body&gt;&#34;</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;SingleThreadedServer time: &#34;</span>
                        <span style=color:#f92672>+</span> time
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/body&gt;&lt;/html&gt;&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>);</span>

                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> responseHeader <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;HTTP/1.1 200 OK\r\n&#34;</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Content-Type: text/html; charset=UTF-8\r\n&#34;</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Content-Length: &#34;</span> <span style=color:#f92672>+</span> responseDocument<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\r\n\r\n&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>);</span>

                output<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>responseHeader<span style=color:#f92672>);</span>
                output<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>responseDocument<span style=color:#f92672>);</span>

                output<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
                input<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>

                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Request processed: &#34;</span> <span style=color:#f92672>+</span> time<span style=color:#f92672>);</span>

            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

<span style=color:#75715e>/// ...
</span></code></pre></div><p>Khi thread ch√≠nh nh·∫≠n connection t·ª´ client, m·ªôt thread m·ªõi s·∫Ω ƒë∆∞·ª£c t·∫°o ra v√† truy·ªÅn <code>clientSocket</code> v√†o cho worker thread x·ª≠ l√Ω nh∆∞ sau:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/// ...
</span><span style=color:#75715e></span>
        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>isStopped<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            Socket clientSocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                clientSocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverSocket</span><span style=color:#f92672>.</span><span style=color:#a6e22e>accept</span><span style=color:#f92672>();</span>

            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isStopped<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Server stopped&#34;</span><span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span>
                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Error on accept client connection&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>

            <span style=color:#f92672>}</span>
            <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> RunnableWorker<span style=color:#f92672>(</span>clientSocket<span style=color:#f92672>)).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>

<span style=color:#75715e>/// ...
</span></code></pre></div><p>ƒê√¢y ch·ªâ l√† m·ªôt v√≠ d·ª• ƒë∆°n gi·∫£n hi·ªán th·ª±c m·ªôt multithreaded server. Hi·ªán t·∫°i Java ƒë√£ c√≥ r·∫•t nhi·ªÅu framework cho web server, c√°c b·∫°n c≈©ng c√≥ th·ªÉ tham kh·∫£o ·ªü b√†i vi·∫øt n√†y.</p><p>T√¨m hi·ªÉu th√™m v·ªÅ:</p><ul><li><a href=/post/tutorial/java/basic/thread/singlethreaded-server-trong-java/>Singlethreaded server</a></li><li><a href=/post/tutorial/java/basic/thread/thread-pooled-server-trong-java/>Thread Pooled server</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/java-thread/ rel=tag>Java Thread</a></li><li class=tags__item><a class="tags__link btn" href=/tags/java-basic/ rel=tag>Java Basic</a></li><li class=tags__item><a class="tags__link btn" href=/tags/java/ rel=tag>Java</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Ha. Huynh Sam avatar" src=/img/avatar.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Ha. Huynh Sam</span></div><div class=authorbox__description>HaHS's true identity is unknown. Maybe he is a successful blogger or writer. Nobody knows it. Do you know him? Let me know that üòâ.</div></div><nav class="post-nav flex"><div class="post-nav__item post-nav__item--prev"><a class=post-nav__link href=/post/tutorial/java/basic/thread/singlethreaded-server-trong-java/ rel=prev><span class=post-nav__caption>¬´&#8201;Previous</span><p class=post-nav__post-title>Singlethreaded Server trong Java</p></a></div><div class="post-nav__item post-nav__item--next"><a class=post-nav__link href=/post/tutorial/java/basic/thread/thread-pooled-server-trong-java/ rel=next><span class=post-nav__caption>Next&#8201;¬ª</span><p class=post-nav__post-title>Thread Pooled Server trong Java</p></a></div></nav></div><aside class=sidebar><div class="post__toc toc toc_sidebar m-t-30 m-b-50"><div class=toc__title>Table of contents</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#multithreaded-server>Multithreaded server</a></li><li><a href=#hi·ªán-th·ª±c-m·ªôt-multithreaded-server>Hi·ªán th·ª±c m·ªôt multithreaded server</a></li></ul></nav></div></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/post/tutorial/java/basic/thread/thread-pooled-server-trong-java/>Thread Pooled Server trong Java</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/java/basic/thread/multithreaded-server-trong-java/>Multithreaded Server trong Java</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/java/basic/thread/singlethreaded-server-trong-java/>Singlethreaded Server trong Java</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/database/memcached-la-gi-va-cach-luu-tru-trong-memcached/>Memcached l√† g√¨? C√°ch l∆∞u tr·ªØ trong Memcacheds</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/cloud/launch-amazon-ec2-instance-with-aws-free-tier-ubuntu-server-18/>Launch Amazon EC2 Instance with AWS Free Tier - Ubuntu Server 18.04 LTS</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/nodejs/advance/how-to-use-es7-import-export-and-async-await-nodejs/>How to Use ES7 Import/Export, Async/Await in Node.js?</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/cloud-tutorial/>Cloud Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/database-tutorial/>Database Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/heroku-tutorial/>Heroku Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/java-tutorial/>Java Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/linux-tutorial/>Linux Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/nodejs-tutorial/>NodeJS Tutorial</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/aws/ title=AWS>AWS (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/aws-ec2/ title="AWS - EC2">AWS - EC2 (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/cloud/ title=Cloud>Cloud (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/database/ title=Database>Database (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/google-apis/ title="Google APIs">Google APIs (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/heroku-deployment/ title="Heroku Deployment">Heroku Deployment (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java/ title=Java>Java (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java-basic/ title="Java Basic">Java Basic (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java-thread/ title="Java Thread">Java Thread (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/linux/ title=Linux>Linux (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/memcached/ title=Memcached>Memcached (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mongodb/ title=MongoDB>MongoDB (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mongoose/ title=Mongoose>Mongoose (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs/ title=NodeJS>NodeJS (5)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs-advance/ title="NodeJS Advance">NodeJS Advance (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs-deployment/ title="NodeJS Deployment">NodeJS Deployment (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/pgadmin/ title=pgAdmin>pgAdmin (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/postgresql/ title=PostgreSQL>PostgreSQL (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/robomongo/ title=Robomongo>Robomongo (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/sequelize/ title=Sequelize>Sequelize (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/ubuntu/ title=Ubuntu>Ubuntu (1)</a></div></div><span class="widget-social widget m-b-15"><h4 class="widget-social__title widget__title">Social</h4><div class="widget-social__content widget__content"><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-github" title=GitHub rel="noopener noreferrer" href=https://github.com/WeAreNoDev target=_blank><svg class="widget-social__link-icon icon icon-github" width="20" height="20" viewBox="0 0 384 374"><path d="m192 0C85.9.0.0 85.8.0 191.7c0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2.0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8.0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7.0.0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4.0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5.0 25.6-.2 46.3-.2 52.6.0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-twitter" title=Twitter rel="noopener noreferrer" href=https://twitter.com/huynhsamha target=_blank><svg class="widget-social__link-icon icon icon-twitter" width="20" height="20" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6.0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-email" title=Email href=mailto:huynhsamha@gmail.com><svg class="widget-social__link-icon icon icon-mail" width="20" height="20" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-linkedin" title=LinkedIn rel="noopener noreferrer" href=https://linkedin.com/in/huynhsamha target=_blank><svg class="widget-social__link-icon icon icon-linkedin" width="20" height="20" viewBox="0 0 352 352"><path d="M0 40v272c0 21.9 18.1 40 40 40h272c21.9.0 40-18.1 40-40V40c0-21.9-18.1-40-40-40H40C18.1.0.0 18.1.0 40zm312-8c4.6.0 8 3.4 8 8v272c0 4.6-3.4 8-8 8H40c-4.6.0-8-3.4-8-8V40c0-4.6 3.4-8 8-8H312zM59.5 87c0 15.2 12.3 27.5 27.5 27.5s27.5-12.3 27.5-27.5S102.2 59.5 87 59.5 59.5 71.8 59.5 87zM187 157h-1v-21h-45v152h47v-75c0-19.8 3.9-39 28.5-39 24.2.0 24.5 22.4 24.5 40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5 132.5 193.3 145.1 187 157zM64 288h47.5V136H64V288z"/></svg></a></span></div></span></aside></div><footer class=footer><div class="container footer__container"><div class=footer__copyright>WeAreNoDev &copy; 2020<div><span class=footer__copyright-credits>Made with<i class="fa fa-heart m-l-5 m-r-5" style=color:#eb0025></i>by
<a href=https://github.com/huynhsamha target=_blank>Ha. Huynh Sam</a></span></div></div></div></footer></div><script type=text/javascript src=/js/menu.min.f829e662179f8ddc402f702fdfcf8572.js integrity="md5-+CnmYhefjdxAL3Av38+Fcg=="></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>