<!doctype html><html class=no-js lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#ffffff"><title>Thread Pooled Server trong Java - We Are No Dev</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content="Bài viết này giới thiệu về thread pooled server trong Java, nằm trong chuỗi bài viết về các kiểu thiết kế đa luồng cho server trong Java. Mỗi kiểu thiết kế sẽ có ưu và nhược điểm riêng của nó."><meta property="og:title" content="Thread Pooled Server trong Java"><meta property="og:description" content="Bài viết này giới thiệu về thread pooled server trong Java, nằm trong chuỗi bài viết về các kiểu thiết kế đa luồng cho server trong Java. Mỗi kiểu thiết kế sẽ có ưu và nhược điểm riêng của nó."><meta property="og:type" content="article"><meta property="og:url" content="/post/tutorial/java/basic/thread/thread-pooled-server-trong-java/"><meta property="article:published_time" content="2019-08-19T00:00:00+00:00"><meta property="article:modified_time" content="2019-08-19T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Thread Pooled Server trong Java"><meta name=twitter:description content="Bài viết này giới thiệu về thread pooled server trong Java, nằm trong chuỗi bài viết về các kiểu thiết kế đa luồng cho server trong Java. Mỗi kiểu thiết kế sẽ có ưu và nhược điểm riêng của nó."><link rel=icon type=image/png href=/favicon.png><link rel=apple-touch-icon href=/favicon.png><meta name=msapplication-TileImage content="/favicon.png"><link href="https://fonts.googleapis.com/css2?family=Muli:ital,wght@0,400;0,500;0,700;0,800;1,400&display=swap" rel=stylesheet><link href=/vendor/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><link rel=stylesheet href=/css/style.min.aa2e8a1d086448d703765915e276f895.css integrity="md5-qi6KHQhkSNcDdlkV4nb4lQ=="><link rel=stylesheet href=/css/spacing_helpers.min.css><link rel=stylesheet href=/css/custom.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-162061519-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class=logo><a href=/ title="We Are No Dev" rel=home><img src=/favicon.png alt="We Are No Dev" class=header__favicon></a>
<a class=logo__link href=/ title="We Are No Dev" rel=home><div class=logo__title>We Are No Dev</div><div class=logo__tagline>We are NOT ONLY Developers</div></a><img src=/img/outline-banner.png alt="We Are No Dev" class=header__banner_img></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Thread Pooled Server trong Java</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2019-08-19T00:00:00Z>Aug 19, 2019</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/java-tutorial/ rel=category>Java Tutorial</a></span></div></div></header><div class="post__toc toc toc_mobile"><div class=toc__title>Table of contents</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#1-pool-và-thread-pool>1. Pool và Thread Pool?</a><ul><li><a href=#11-queue-trong-thread-pool>1.1. Queue trong Thread Pool</a></li><li><a href=#12-pool-chứa-các-thread>1.2. Pool chứa các thread</a></li></ul></li><li><a href=#2-thread-pooled-server>2. Thread Pooled Server</a></li><li><a href=#3-hiện-thực-một-threadpooled-server>3. Hiện thực một threadpooled server</a></li></ul></nav></div></div><div class="content post__content clearfix"><p><strong>Thread Pooled server</strong> là một kiểu thiết kế server thuộc kiểu multithreaded, tuy nhiên thay vì tạo mới các thread cho mỗi request đến, kiểu thiết kế này sử dụng một pool các thread để tái sử dụng. Để phân biệt các kiểu thiết kế này, các bạn có thể tham khảo trong chuỗi bài viết này.</p><h2 id=1-pool-và-thread-pool>1. Pool và Thread Pool?</h2><p>Trong Java hay trong các ngôn ngữ tương tự, khái niệm <code>Pool</code> thường được sử dụng như một <em>hồ</em> chứa các đối tượng có thể tái sử dụng. Ví dụ <code>Thread Pool</code> là một pool chứa các threads hay <code>Connection Pool</code> là một pool chứa các connections. Việc sử dụng pool giúp ta có thể quản lý các đối tượng tạo ra, tái sử dụng lại đối tượng này, cũng như có thể giải phóng khi không dùng, tạo mới khi thiếu. Và hơn hết có thể giúp ta cấu hình các thông số như giới hạn số lượng tạo ra, hạn chế việc tạo lại, &mldr;</p><p>Trong hình dưới đây minh hoạ về thread pool. Mỗi thread pool sẽ có 2 vấn đề cần quan tâm:</p><ul><li><code>Queue</code> chứa các <code>task</code>, hay <code>job</code></li><li><code>Pool</code> chứa các threads</li></ul><div class="center m-t-20 m-b-20"><img src=/img/post/java/thread/threadpool.jpg alt=ThreadPool width=80% decoding=async></div><h3 id=11-queue-trong-thread-pool>1.1. Queue trong Thread Pool</h3><p>Queue là một hàng đợi chứa các tác vụ (task) hay công việc (job) mà các thread cần thực hiện. Với Queue, chúng ta có thể cấu hình một số thông số sau:</p><ul><li>Kích thước queue: giới hạn về kích thước queue có thể chứa</li><li>Cách queue lưu trữ: thông thường là <code>FIFO (First In First Out)</code>, cũng có thể sử dụng <code>Priority</code> (có độ ưu tiên cho các job)</li></ul><p>Khi phía ứng dụng gửi các job sang thread pool, các job này được đẩy vào một hàng đợi queue để chờ xử lý. Thứ tự xử lý các job dựa trên cách mà queue lưu trữ, thông thường là <code>FIFO</code>. Các thread trong pool được chọn ra để xử lý lần lượt các job từ queue này.</p><h3 id=12-pool-chứa-các-thread>1.2. Pool chứa các thread</h3><p>Pool như đã đề cập là một nơi chứa các thread. Một số cấu hình cho một pool như sau:</p><ul><li>Lượng thread tối đa được active</li><li>Lượng thread tối đa ở trạng thái idle (khi không có job)</li><li>Lượng thread tối thiẻu ở trạn thái idle (khi không có job)</li><li>Lượng thread khi khởi tạo (tạo sẵn các thread lúc start)</li><li>Kiểu thread pool được sử dụng (fix, dynamic, cache, scheduler, &mldr;)</li></ul><p>Khi queue trống, các thread trong pool ở trạng thái idle. Khi queue nhận job, thread pool chọn ra một thread rỗi để xử lý một job, đến khi job hoàn tất, thread được giải phóng và trả lại cho pool.</p><h2 id=2-thread-pooled-server>2. Thread Pooled Server</h2><p><code>Thread Pooled Server</code> sử dụng cơ chế <a href=/post/tutorial/java/basic/thread/multithreaded-server-trong-java/>multithreaded server</a> kết hợp với việc sử dụng một thread pool để quản lý các thread dùng để handle các connection từ client.</p><p>Việc sử dụng thread pool giúp tránh tạo quá nhiều thread khi có lượng lớn connection xảy ra đồng thời (concurrency), cũng như tái sử dụng các thread, tránh gây lãng phí khi tạo mơis và huỷ thread liên tục.</p><p>Dưới đây là một ví dụ minh hoạ hiện thực một threadpooled server:</p><h2 id=3-hiện-thực-một-threadpooled-server>3. Hiện thực một threadpooled server</h2><p>Dưới đây là một hiện thực đơn giản cho threadpooled server, xem <a href=https://github.com/wearenodev/java-examples/blob/master/src/wearenodev/java/examples/thread/ThreadPooledServer.java>mã nguồn ví dụ tại đây</a>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/*
</span><span style=color:#75715e> * License from https://github.com/wearenodev
</span><span style=color:#75715e> */</span>
<span style=color:#f92672>package</span> wearenodev.java.examples.thread<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> java.io.IOException<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.io.InputStream<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.io.OutputStream<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.net.ServerSocket<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.net.Socket<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.ExecutorService<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.concurrent.Executors<span style=color:#f92672>;</span>

<span style=color:#75715e>/**
</span><span style=color:#75715e> *
</span><span style=color:#75715e> * @author harisk
</span><span style=color:#75715e> */</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ThreadPooledServer</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>

    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * Worker Thread
</span><span style=color:#75715e>     */</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RunnableWorker</span> <span style=color:#66d9ef>implements</span> Runnable <span style=color:#f92672>{</span>

        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Socket clientSocket<span style=color:#f92672>;</span>

        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RunnableWorker</span><span style=color:#f92672>(</span>Socket clientSocket<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>clientSocket</span> <span style=color:#f92672>=</span> clientSocket<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>

        <span style=color:#a6e22e>@Override</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                InputStream input <span style=color:#f92672>=</span> clientSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>getInputStream</span><span style=color:#f92672>();</span>
                OutputStream output <span style=color:#f92672>=</span> clientSocket<span style=color:#f92672>.</span><span style=color:#a6e22e>getOutputStream</span><span style=color:#f92672>();</span>

                <span style=color:#66d9ef>long</span> time <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> responseDocument <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;&lt;html&gt;&lt;body&gt;&#34;</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;SingleThreadedServer time: &#34;</span>
                        <span style=color:#f92672>+</span> time
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;/body&gt;&lt;/html&gt;&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>);</span>

                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> responseHeader <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#e6db74>&#34;HTTP/1.1 200 OK\r\n&#34;</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Content-Type: text/html; charset=UTF-8\r\n&#34;</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;Content-Length: &#34;</span> <span style=color:#f92672>+</span> responseDocument<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span>
                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;\r\n\r\n&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;UTF-8&#34;</span><span style=color:#f92672>);</span>

                output<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>responseHeader<span style=color:#f92672>);</span>
                output<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>responseDocument<span style=color:#f92672>);</span>

                output<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
                input<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>

                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Request processed: &#34;</span> <span style=color:#f92672>+</span> time<span style=color:#f92672>);</span>

            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> serverPort<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> ServerSocket serverSocket<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> isStopped <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ExecutorService threadPool<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ThreadPooledServer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> port<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> poolSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverPort</span> <span style=color:#f92672>=</span> port<span style=color:#f92672>;</span>
        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * Initial new thread pool with fix size
</span><span style=color:#75715e>         */</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadPool</span> <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newFixedThreadPool</span><span style=color:#f92672>(</span>poolSize<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isStopped</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isStopped</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>stop</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isStopped</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverSocket</span><span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>

        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Error on stop server&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>openServerSocket</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverSocket</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServerSocket<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverPort</span><span style=color:#f92672>);</span>
            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Server is running on port &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverPort</span><span style=color:#f92672>);</span>

        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cannot open port &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverPort</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>

        openServerSocket<span style=color:#f92672>();</span>

        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>isStopped<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            Socket clientSocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                clientSocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverSocket</span><span style=color:#f92672>.</span><span style=color:#a6e22e>accept</span><span style=color:#f92672>();</span>

            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isStopped<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Server stopped&#34;</span><span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span>
                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Error on accept client connection&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>

            <span style=color:#f92672>}</span>

            <span style=color:#75715e>/**
</span><span style=color:#75715e>             * Push job to threadpool, threadpool will select a free thread
</span><span style=color:#75715e>             * to handle this job, if all threads&#39;re busy, job will be in queue
</span><span style=color:#75715e>             * and wait until exist a free thread
</span><span style=color:#75715e>             */</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadPool</span><span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>
                    <span style=color:#66d9ef>new</span> RunnableWorker<span style=color:#f92672>(</span>clientSocket<span style=color:#f92672>)</span>
            <span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>

        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * Shutdown threadpool
</span><span style=color:#75715e>         */</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadPool</span><span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Server stopped&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>

        <span style=color:#66d9ef>int</span> poolSize <span style=color:#f92672>=</span> 10<span style=color:#f92672>;</span>
        ThreadPooledServer server <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadPooledServer<span style=color:#f92672>(</span>8080<span style=color:#f92672>,</span> poolSize<span style=color:#f92672>);</span>

        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * Run server in single thread
</span><span style=color:#75715e>         */</span>
        <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span>server<span style=color:#f92672>).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>

        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * Waiting 20s before stopping server
</span><span style=color:#75715e>         */</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>20 <span style=color:#f92672>*</span> 1000<span style=color:#f92672>);</span>

        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            ex<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>

        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * Stop server and exit processR
</span><span style=color:#75715e>         */</span>
        server<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>exit</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Trong ví dụ trên, ta sử dụng một <code>ExecutorService</code> trong Java như một thread pool, khởi tạo đơn giản bằng <code>Executors.newFixedThreadPool(poolSize)</code>, giúp tạo một thread pool với kích thước được fix là <code>poolSize</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/// ...
</span><span style=color:#75715e></span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> serverPort<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> ServerSocket serverSocket<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> isStopped <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> ExecutorService threadPool<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ThreadPooledServer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> port<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> poolSize<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverPort</span> <span style=color:#f92672>=</span> port<span style=color:#f92672>;</span>
        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * Initial new thread pool with fix size
</span><span style=color:#75715e>         */</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadPool</span> <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newFixedThreadPool</span><span style=color:#f92672>(</span>poolSize<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

<span style=color:#75715e>/// ...
</span></code></pre></div><p>Khi nhận được request từ client, ta đưa request này cho thread pool xử lý, tức request được lưu trữ trên queue của thread pool:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/// ...
</span><span style=color:#75715e></span>
        <span style=color:#66d9ef>while</span> <span style=color:#f92672>(!</span>isStopped<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
            Socket clientSocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
                clientSocket <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverSocket</span><span style=color:#f92672>.</span><span style=color:#a6e22e>accept</span><span style=color:#f92672>();</span>

            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isStopped<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Server stopped&#34;</span><span style=color:#f92672>);</span>
                    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
                <span style=color:#f92672>}</span>
                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Error on accept client connection&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>

            <span style=color:#f92672>}</span>

            <span style=color:#75715e>/**
</span><span style=color:#75715e>             * Push job to threadpool, threadpool will select a free thread
</span><span style=color:#75715e>             * to handle this job, if all threads&#39;re busy, job will be in queue
</span><span style=color:#75715e>             * and wait until exist a free thread
</span><span style=color:#75715e>             */</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadPool</span><span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>
                    <span style=color:#66d9ef>new</span> RunnableWorker<span style=color:#f92672>(</span>clientSocket<span style=color:#f92672>)</span>
            <span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>

<span style=color:#75715e>/// ...
</span></code></pre></div><p>Việc tuỳ chỉnh Thread Pool như thế nào là dựa vào tính chất của service mà ta cần xử lý. Trên đây chỉ là một minh hoạ đơn giản. Các bạn có thể tìm hiểu thêm nhiều hơn về Thread pool trong <a href=/>bài viết này</a>.</p><p>Tìm hiểu thêm về:</p><ul><li><a href=/post/tutorial/java/basic/thread/singlethreaded-server-trong-java/>Singlethreaded server</a></li><li><a href=/post/tutorial/java/basic/thread/multithreaded-server-trong-java/>Multithreaded server</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/java-thread/ rel=tag>Java Thread</a></li><li class=tags__item><a class="tags__link btn" href=/tags/java-basic/ rel=tag>Java Basic</a></li><li class=tags__item><a class="tags__link btn" href=/tags/java/ rel=tag>Java</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Ha. Huynh Sam avatar" src=/img/avatar.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Ha. Huynh Sam</span></div><div class=authorbox__description>HaHS's true identity is unknown. Maybe he is a successful blogger or writer. Nobody knows it. Do you know him? Let me know that 😉.</div></div><nav class="post-nav flex"><div class="post-nav__item post-nav__item--prev"><a class=post-nav__link href=/post/tutorial/java/basic/thread/multithreaded-server-trong-java/ rel=prev><span class=post-nav__caption>«&#8201;Previous</span><p class=post-nav__post-title>Multithreaded Server trong Java</p></a></div><div class="post-nav__item post-nav__item--next"><a class=post-nav__link href=/post/tutorial/javascript/advance/remove-accents-in-vietnamese/ rel=next><span class=post-nav__caption>Next&#8201;»</span><p class=post-nav__post-title>Chuyển từ Tiếng Việt có dấu về chữ cái Latin trong JavaScript</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"wearenodev"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><aside class=sidebar><div class="post__toc toc toc_sidebar m-t-30 m-b-50"><div class=toc__title>Table of contents</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#1-pool-và-thread-pool>1. Pool và Thread Pool?</a><ul><li><a href=#11-queue-trong-thread-pool>1.1. Queue trong Thread Pool</a></li><li><a href=#12-pool-chứa-các-thread>1.2. Pool chứa các thread</a></li></ul></li><li><a href=#2-thread-pooled-server>2. Thread Pooled Server</a></li><li><a href=#3-hiện-thực-một-threadpooled-server>3. Hiện thực một threadpooled server</a></li></ul></nav></div></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/post/tutorial/javascript/advance/vietnamese-search-in-datatables/>Tìm kiếm dữ liệu Tiếng Việt không dấu trong DataTables</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/javascript/advance/remove-accents-in-vietnamese/>Chuyển từ Tiếng Việt có dấu về chữ cái Latin trong JavaScript</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/java/basic/thread/thread-pooled-server-trong-java/>Thread Pooled Server trong Java</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/java/basic/thread/multithreaded-server-trong-java/>Multithreaded Server trong Java</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/java/basic/thread/singlethreaded-server-trong-java/>Singlethreaded Server trong Java</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/database/memcached-la-gi-va-cach-luu-tru-trong-memcached/>Memcached là gì? Cách lưu trữ trong Memcacheds</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/cloud-tutorial/>Cloud Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/database-tutorial/>Database Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/heroku-tutorial/>Heroku Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/java-tutorial/>Java Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/javascript-tutorial/>JavaScript Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/linux-tutorial/>Linux Tutorial</a></li><li class=widget__item><a class=widget__link href=/categories/nodejs-tutorial/>NodeJS Tutorial</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/adminlte2/ title=AdminLTE2>AdminLTE2 (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/aws/ title=AWS>AWS (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/aws-ec2/ title="AWS - EC2">AWS - EC2 (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/cloud/ title=Cloud>Cloud (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/database/ title=Database>Database (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/google-apis/ title="Google APIs">Google APIs (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/heroku-deployment/ title="Heroku Deployment">Heroku Deployment (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java/ title=Java>Java (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java-basic/ title="Java Basic">Java Basic (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java-thread/ title="Java Thread">Java Thread (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/javascript/ title=JavaScript>JavaScript (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/javascript-advance/ title="JavaScript Advance">JavaScript Advance (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/jsrmvi/ title=jsrmvi>jsrmvi (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/linux/ title=Linux>Linux (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/memcached/ title=Memcached>Memcached (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mongodb/ title=MongoDB>MongoDB (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mongoose/ title=Mongoose>Mongoose (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs/ title=NodeJS>NodeJS (5)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs-advance/ title="NodeJS Advance">NodeJS Advance (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs-deployment/ title="NodeJS Deployment">NodeJS Deployment (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/npm/ title=NPM>NPM (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/pgadmin/ title=pgAdmin>pgAdmin (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/postgresql/ title=PostgreSQL>PostgreSQL (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/robomongo/ title=Robomongo>Robomongo (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/sequelize/ title=Sequelize>Sequelize (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/ubuntu/ title=Ubuntu>Ubuntu (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/vietnamese/ title=Vietnamese>Vietnamese (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/vietnamese-search/ title="Vietnamese Search">Vietnamese Search (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/webpack/ title=Webpack>Webpack (1)</a></div></div><span class="widget-social widget m-b-15"><h4 class="widget-social__title widget__title">Social</h4><div class="widget-social__content widget__content"><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-github" title=GitHub rel="noopener noreferrer" href=https://github.com/WeAreNoDev target=_blank><i class="fa fa-github-square"></i></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-twitter" title=Twitter rel="noopener noreferrer" href=https://twitter.com/huynhsamha target=_blank><i class="fa fa-twitter-square"></i></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-email" title=Email href=mailto:huynhsamha@gmail.com><i class="fa fa-envelope-square"></i></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-linkedin" title=LinkedIn rel="noopener noreferrer" href=https://linkedin.com/in/huynhsamha target=_blank><i class="fa fa-linkedin-square"></i></a></span></div></span></aside></div><footer class=footer><div class="container footer__container"><div class=footer__copyright>WeAreNoDev &copy; 2020<div><span class=footer__copyright-credits>Made with<i class="fa fa-heart m-l-5 m-r-5" style=color:#eb0025></i>by
<a href=https://github.com/huynhsamha target=_blank>Ha. Huynh Sam</a></span></div></div></div></footer></div><span id=scroll-top><i class="fa fa-caret-up"></i></span><script src=/vendor/jquery/3.5.1/jquery.min.js></script><script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script><script type=text/javascript src=/js/main.min.f422027a0caaf9eadab59acbeb7e0d9a.js integrity="md5-9CICegyq+eratZrL634Nmg=="></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>