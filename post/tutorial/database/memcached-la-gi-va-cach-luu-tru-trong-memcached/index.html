<!doctype html><html class=no-js lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#ffffff"><title>Memcached là gì? Cách lưu trữ trong Memcached - We Are No Dev</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content="Understanding Memcached - Tìm hiểu về Memcached, các nguyên tắc hoạt động ở memcached client, memcached server, các khái niệm Consistent Hashing, Slab Allocation, cách hiện thực LRU và Hash Table trong memcached server."><meta property="og:title" content="Memcached là gì? Cách lưu trữ trong Memcached"><meta property="og:description" content="Understanding Memcached - Tìm hiểu về Memcached, các nguyên tắc hoạt động ở memcached client, memcached server, các khái niệm Consistent Hashing, Slab Allocation, cách hiện thực LRU và Hash Table trong memcached server."><meta property="og:type" content="article"><meta property="og:url" content="/post/tutorial/database/memcached-la-gi-va-cach-luu-tru-trong-memcached/"><meta property="article:published_time" content="2019-08-08T00:00:00+00:00"><meta property="article:modified_time" content="2019-08-08T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Memcached là gì? Cách lưu trữ trong Memcached"><meta name=twitter:description content="Understanding Memcached - Tìm hiểu về Memcached, các nguyên tắc hoạt động ở memcached client, memcached server, các khái niệm Consistent Hashing, Slab Allocation, cách hiện thực LRU và Hash Table trong memcached server."><link rel=icon type=image/png href=/favicon.png><link rel=apple-touch-icon href=/favicon.png><meta name=msapplication-TileImage content="/favicon.png"><link href="https://fonts.googleapis.com/css2?family=Muli:ital,wght@0,400;0,500;0,700;0,800;1,400&display=swap" rel=stylesheet><link href=/vendor/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><link rel=stylesheet href=/css/style.min.3593336bd12106f4ab3d37ce2fd3db6b.css integrity="md5-NZMza9EhBvSrPTfOL9Pbaw=="><link rel=stylesheet href=/css/spacing_helpers.min.css><link rel=stylesheet href=/css/custom.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-162061519-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class=logo><a href=/ title="We Are No Dev" rel=home><img src=/favicon.png alt="We Are No Dev" class=header__favicon></a>
<a class=logo__link href=/ title="We Are No Dev" rel=home><div class=logo__title>We Are No Dev</div><div class=logo__tagline>We are NOT ONLY Developers</div></a><img src=/img/outline-banner.png alt="We Are No Dev" class=header__banner_img></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Memcached là gì? Cách lưu trữ trong Memcached</h1><div class="post__meta meta"><div class="meta__item meta__item-lang"><i class=meta__icon><img src=/icon/vi64.png alt=vi width=16px></i>
<span class=meta__text>Vietnamese</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2019-08-08T00:00:00Z>Aug 08, 2019</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/database/ rel=category>Database</a></span></div></div></header><div class="post__toc toc toc_mobile"><div class=toc__title>Table of contents</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#overview>Overview</a><ul><li><a href=#features>Features</a></li><li><a href=#design-philosophy>Design Philosophy</a></li></ul></li><li><a href=#detail>Detail</a><ul><li><a href=#memcached-client>Memcached Client</a></li><li><a href=#memcached-server>Memcached Server</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></div><div class="content post__content clearfix"><p><strong>Understanding Memcached</strong> - Tìm hiểu về <strong>Memcached</strong>, các nguyên tắc hoạt động ở <em>memcached client</em>, <em>memcached server</em>, các khái niệm <code>Consistent Hashing</code>, <code>Slab Allocation</code>, cách hiện thực <em>LRU</em> và <em>Hash Table</em> trong memcached server.</p><div class="center m-t-20 m-b-20"><img src=/img/background/memcached-bg.jpg alt width=400px decoding=async></div><h2 id=overview>Overview</h2><p><strong>Memcached</strong> là <strong>hệ thống caching</strong> <strong><em>dữ liệu phân tán</em></strong>, lưu trữ trên <strong>memory</strong> dạng <strong><em>key - value</em></strong>.</p><p>Dữ liệu lưu trữ dạng key-value với <code>key</code> là <code>string</code>, <code>value</code> là một <code>object</code> (<em>serializable</em>)</p><p><strong>Use-cases</strong>: lưu các API calls, database calls, page rendering, &mldr;</p><h3 id=features>Features</h3><p>Một số điểm mạnh trong memcached:</p><ul><li>Xử lý tốt vấn đề <em>phân mảnh vùng nhớ</em> (<strong>memory fragments</strong>), quản lý vùng nhớ hiệu quả.</li><li>Có khả năng <strong>phân tán độc lập</strong> các <em>memcached server</em>.</li><li>Giao tiếp từ 2 phía client và server riêng biệt.</li></ul><h3 id=design-philosophy>Design Philosophy</h3><p>Các nguyên tắc trong thiết kế của Memcached:</p><ul><li><strong>Key-Value</strong> dạng đơn giản, với key là string, value có thể được serialized</li><li><strong>Half in Client, Half in Server</strong>:<ul><li>client chọn server để lưu trữ dựa trên key qua hàm hash và danh sách các servers</li><li>server chỉ quản lý các giá trị được lưu trữ và quản lý vùng nhớ của nó</li></ul></li><li>Servers trong memcached là <em>disconnected</em>: <em>no crosstalk, no syncronization, no broadcasting, no replication</em></li><li><strong>Forgetting is a Feature</strong>: dùng LRU, expiration time. <em>Không dùng garbage collector</em> đảm bảo độ trễ thấp, sử dụng <em>lazy deletion</em>.</li></ul><h2 id=detail>Detail</h2><h3 id=memcached-client>Memcached Client</h3><ul><li>Các clients cần có cùng config về list các servers memcached, kể cả số lượng và thứ tự các servers. Về cơ bản, mỗi client dựa trên giá trị key, sử dụng hàm hash hợp lý, lấy module cho số lượng server để tìm index của server đảm nhận key đó.</li></ul><h4 id=consistent-hashing>Consistent Hashing</h4><p>Memcached client quyết định server nào được chọn cho mỗi giá trị key thông qua hàm hash, dựa trên giá trị mod cho số servers hiện active. Do đó, khi có việc thêm/bớt server memcached dẫn đến các giá trị key bị remapped trội lên, gây cache miss, nên cần sử dụng <strong>Consistent Hashing</strong> để giảm bớt việc shift các servers khi xảy ra việc thêm/bớt memcached server.</p><p><strong>Consistent Hashing</strong> là kỹ thuật <em>map</em> mỗi key đến giá trị <em>không phụ thuộc vào số lượng servers</em> biết trước, tránh sử dụng phép module khi kích thước <code>N</code> bị thay đổi.</p><p>Kỹ thuật này đưa vùng không gian giá trị khóa key lên 1 vòng tròn, map mỗi giá trị đến điểm gần nó nhất theo hướng ngược chiều kim đồng hồ như hình dưới đây:</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/consistent-hashing.png alt width decoding=async></div><p>Như hình trên, các giá trị hash của các khóa được map lên một điểm trên vòng tròn.</p><p>Trong ngôn ngữ <code>Java</code>, ta sử dụng thư viện <a href=https://mvnrepository.com/artifact/net.spy/spymemcached/2.12.0>spymemcached-2.12.0</a> để thực hiện connect đến Memcached Server. Dưới đây là một số điều mình đã tìm hiểu về thư viện này:</p><p>Trong <code>spymemcached-2.12.0</code>, khi khởi tạo một memcached client (<code>mcc</code>), cho phép ta config <code>ConnectionFactory</code>, hoặc sử dụng <code>DefaultConnectionFactory</code> của thư viện.</p><p>Mặc định <code>DefaultConnectionFactory</code> sử dụng <code>ArrayModNodeLocator</code>, một implementation của <code>NodeLocator</code> sử dụng lookup dựa trên module của hash code trên length của list server.</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/mcc_01.png alt width decoding=async></div><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/mcc_02.png alt width decoding=async></div><p>Ngoài ra, <code>spymemcached-2.12.0</code> cũng hỗ trợ <code>KetamaConnectionFactory</code>, hiện thực từ <code>DefaultConnectionFactory</code> sử dụng <code>KetamaNodeLocator</code> và <em>hàm hash Ketama</em> cho Consistent Hashing.</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/mcc_03.png alt width decoding=async></div><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/mcc_04.png alt width decoding=async></div><h4 id=failover>Failover</h4><p>Vấn đề failover khi xảy ra <strong>crash server</strong>, client sẽ loop next trên server list đến khi tìm thấy server nào còn active và map key hiện tại cho server này.</p><h4 id=compression>Compression</h4><p>Memcached client hỗ trợ cho phép enable hoặc disable compression dựa trên <strong>threshold cho item size</strong>.</p><h3 id=memcached-server>Memcached Server</h3><ul><li><strong>Multiple Instances</strong>: Memcached là một <em>distributed servers</em>, do đó có thể start nhiều instance trên cùng 1 host hoặc nhiều host.</li><li>Networking: hỗ trợ TCP và UDP</li><li>Connection limit và Threading.</li></ul><h4 id=slab-allocation>Slab Allocation</h4><p>Memcached server quản lý memory sử dụng <code>slab allocator</code> <strong>tránh phân mảnh vùng nhớ</strong>. Triết lý của kỹ thuật này là phân đoạn các vùng nhớ đã cấp phát thành các <code>chunks</code> với <em>size</em> được định ra trước đó.</p><p>Ví dụ khi start memcached instance, với option <code>-vv</code>, ta sẽ thấy được các slab class được memcached phân đoạn như sau:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>memcached -p <span style=color:#ae81ff>11112</span> -vv
slab class   1: chunk size        <span style=color:#ae81ff>96</span> perslab   <span style=color:#ae81ff>10922</span>
slab class   2: chunk size       <span style=color:#ae81ff>120</span> perslab    <span style=color:#ae81ff>8738</span>
slab class   3: chunk size       <span style=color:#ae81ff>152</span> perslab    <span style=color:#ae81ff>6898</span>
slab class   4: chunk size       <span style=color:#ae81ff>192</span> perslab    <span style=color:#ae81ff>5461</span>
slab class   5: chunk size       <span style=color:#ae81ff>240</span> perslab    <span style=color:#ae81ff>4369</span>
slab class   6: chunk size       <span style=color:#ae81ff>304</span> perslab    <span style=color:#ae81ff>3449</span>
slab class   7: chunk size       <span style=color:#ae81ff>384</span> perslab    <span style=color:#ae81ff>2730</span>
slab class   8: chunk size       <span style=color:#ae81ff>480</span> perslab    <span style=color:#ae81ff>2184</span>
slab class   9: chunk size       <span style=color:#ae81ff>600</span> perslab    <span style=color:#ae81ff>1747</span>
slab class  10: chunk size       <span style=color:#ae81ff>752</span> perslab    <span style=color:#ae81ff>1394</span>
slab class  11: chunk size       <span style=color:#ae81ff>944</span> perslab    <span style=color:#ae81ff>1110</span>
slab class  12: chunk size      <span style=color:#ae81ff>1184</span> perslab     <span style=color:#ae81ff>885</span>
slab class  13: chunk size      <span style=color:#ae81ff>1480</span> perslab     <span style=color:#ae81ff>708</span>
slab class  14: chunk size      <span style=color:#ae81ff>1856</span> perslab     <span style=color:#ae81ff>564</span>
slab class  15: chunk size      <span style=color:#ae81ff>2320</span> perslab     <span style=color:#ae81ff>451</span>
slab class  16: chunk size      <span style=color:#ae81ff>2904</span> perslab     <span style=color:#ae81ff>361</span>
slab class  17: chunk size      <span style=color:#ae81ff>3632</span> perslab     <span style=color:#ae81ff>288</span>
slab class  18: chunk size      <span style=color:#ae81ff>4544</span> perslab     <span style=color:#ae81ff>230</span>
slab class  19: chunk size      <span style=color:#ae81ff>5680</span> perslab     <span style=color:#ae81ff>184</span>
slab class  20: chunk size      <span style=color:#ae81ff>7104</span> perslab     <span style=color:#ae81ff>147</span>
slab class  21: chunk size      <span style=color:#ae81ff>8880</span> perslab     <span style=color:#ae81ff>118</span>
slab class  22: chunk size     <span style=color:#ae81ff>11104</span> perslab      <span style=color:#ae81ff>94</span>
slab class  23: chunk size     <span style=color:#ae81ff>13880</span> perslab      <span style=color:#ae81ff>75</span>
slab class  24: chunk size     <span style=color:#ae81ff>17352</span> perslab      <span style=color:#ae81ff>60</span>
slab class  25: chunk size     <span style=color:#ae81ff>21696</span> perslab      <span style=color:#ae81ff>48</span>
slab class  26: chunk size     <span style=color:#ae81ff>27120</span> perslab      <span style=color:#ae81ff>38</span>
slab class  27: chunk size     <span style=color:#ae81ff>33904</span> perslab      <span style=color:#ae81ff>30</span>
slab class  28: chunk size     <span style=color:#ae81ff>42384</span> perslab      <span style=color:#ae81ff>24</span>
slab class  29: chunk size     <span style=color:#ae81ff>52984</span> perslab      <span style=color:#ae81ff>19</span>
slab class  30: chunk size     <span style=color:#ae81ff>66232</span> perslab      <span style=color:#ae81ff>15</span>
slab class  31: chunk size     <span style=color:#ae81ff>82792</span> perslab      <span style=color:#ae81ff>12</span>
slab class  32: chunk size    <span style=color:#ae81ff>103496</span> perslab      <span style=color:#ae81ff>10</span>
slab class  33: chunk size    <span style=color:#ae81ff>129376</span> perslab       <span style=color:#ae81ff>8</span>
slab class  34: chunk size    <span style=color:#ae81ff>161720</span> perslab       <span style=color:#ae81ff>6</span>
slab class  35: chunk size    <span style=color:#ae81ff>202152</span> perslab       <span style=color:#ae81ff>5</span>
slab class  36: chunk size    <span style=color:#ae81ff>252696</span> perslab       <span style=color:#ae81ff>4</span>
slab class  37: chunk size    <span style=color:#ae81ff>315872</span> perslab       <span style=color:#ae81ff>3</span>
slab class  38: chunk size    <span style=color:#ae81ff>394840</span> perslab       <span style=color:#ae81ff>2</span>
slab class  39: chunk size    <span style=color:#ae81ff>524288</span> perslab       <span style=color:#ae81ff>2</span>
</code></pre></div><p>Khi start memcached, có <code>39 slab class</code> được tạo, với kích thước <code>chunk size</code> ở mỗi slab class <em>tăng dần</em>, chunk size càng lớn, số <code>slot</code> trong slab class càng giảm. Một <code>Slab class</code> là <em>group của các chunks</em> có cùng chunk size, mỗi <code>chunk</code> được gọi là <code>slot</code>, là <em>đơn vị nhỏ nhất để lưu data</em>.</p><p><strong>Growth Factor</strong> là hệ số nhân cho kích thước các slab class kế tiếp, trong instance memcached được start như trên thì Growth Factor là <code>1.25</code>: (<code>120/96 = 1.25 | 152/120 ~ 1.25 | 192/152 ~ 1.25 | 240/192 = 1.25 | bla bla</code>)</p><p>Đây là những config mặc định của memcached về slab class:</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/settings_01.png alt width=700 decoding=async></div><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/settings_02.png alt width=700 decoding=async></div><p>Mặc định <code>growth factor</code> là <strong>1.25</strong>, 1 slab class có size là <code>1MB</code> (<code>slab_page_size</code>), từ chunk size sau khi nhân growth factor, dựa trên slab class size, cấp phát số chunks trong slab class đó. Và 1 slab class yêu cầu tối thiểu <code>2</code> chunks.</p><p>Có thể mô tả các slab class như hình dưới đây:</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/slab_arch.png alt width=400 decoding=async></div><p>Khi nhận được một record, memcached sẽ chọn ra một <strong>slab class fit với size</strong> của record này, sau đó tìm trong các slots trống để sử dụng slot đó cho record, nếu data nào bị expired hoặc deleted, slot đó được nhả lại <em>idle slots</em>.</p><p>==> memcached quản lý vùng nhớ hiệu quả, linh động, không gây memory fragments.</p><p>==> nhược điểm gây dư thừa vùng nhớ không dùng trong mỗi chunk được dùng.</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/space_waste.png alt width decoding=async></div><h5 id=item-in-memcached>Item in Memcached</h5><p>Trong memcached, mỗi records key-value được lưu trữ thành 1 <code>item</code> như sau:</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/item_structure.png alt width=700 decoding=async></div><p>Mỗi item được lưu trữ dạng con trỏ, lưu trữ con trỏ tiếp theo trong chuỗi <code>hash chain</code> (chain lưu trữ các item có cùng hash value, xử lý collision trong hash table).</p><p>Ngoài các thông tin về key, value, còn có thông tin time (expired, access), &mldr;</p><p>Mỗi item khi được lưu vào trong chunk của slab class, được record thành <code>item_chunk</code> và size của item được gọi là <code>header</code> và được tính trước khi tìm ra slab class tương ứng:</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/item_chunk_structure.png alt width=700 decoding=async></div><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/header_item_size.png alt width=700 decoding=async></div><h5 id=slab-class-structure>Slab Class Structure</h5><p>Đây là slab class structure trong memcached</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/slab_001.png alt width=700 decoding=async></div><p>Mỗi slabclass gồm chunk size, số slab, list các slots, &mldr;</p><h4 id=lru-cache-vs-hash-table>LRU Cache vs Hash Table</h4><h5 id=implementation>Implementation</h5><p>Mỗi slab class có một doubly linked list riêng để hiện thực LRU. Ngoài <code>head</code>, <code>tail</code>, còn các giá trị <code>stats</code> về <code>sizes</code>, storage size (<code>sizes_bytes</code>)</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/slab_class_lru.png alt width=400 decoding=async></div><p>Memcached sử dụng một main hash table để lưu trữ các item. Khi lượng item vượt quá 3/2 số bucket trong main hash table, memcached sẽ expand hash table.</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/hash_table.png alt width=700 decoding=async></div><p>Khi thực hiện expand, một maintaner thread start để chia lại các entry trong hash table. Memcached đồng thời lưu trữ 2 bảng băm cho các quá trình update hash table.</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/expanding.png alt width=500 decoding=async></div><p>Trong quá trình tìm kiếm, dựa trên giá trị key và giá trị hash của item header, tìm đến con trỏ đầu tiên trên bảng băm và thực hiện duyệt linked list để tìm ra item:</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/search_item_in_hashtable.png alt width=700 decoding=async></div><p>Do mỗi item trong memcached được lưu trữ dạng pointer trên cả hash table lẫn linked list, do đó các thao tác update lại linkedlist khi thêm phần tử mới, xóa 1 phần tử và update lại LRU state đều chỉ tốn time <code>O(1)</code> - Dựa trên hash table, để tìm ra chuỗi hash collision của item đó, tìm item trên chain này được 1 pointer nên dễ dàng update lại linkedlist trong O(1).</p><p>Do đó độ phức tạp thực chất xảy ra khi có collision trên hash table. Tuy nhiên Memcached cải thiện điều này bằng việc expand bảng băm khi lượng items vượt quá 3/2 số bucket trên hash table nhằm giảm việc đụng độ các giá trị hash.</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/hash_lru.png alt width=500 decoding=async></div><p>Ngoài việc sử dụng expanding hash table, memcached còn thêm 1 trick nhỏ trong quá trình update lại LRU khi 1 lượng items thường xuyên được accessed liên tục, tránh update lại top các items đầu trong linkedlist. Mỗi item đều được lưu trữ time accessed gần nhất, tuy nhiên giá trị này chỉ được update sau 1 interval time mà memcached định ra (<code>60s</code>), do đó chỉ sau 1 khoảng thời gian đủ lâu thì item này mới thực sự update lại trạng thái accessed:</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/item_update_interval.png alt width=700 decoding=async></div><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/do_item_update.png alt width=700 decoding=async></div><h5 id=compare-with-lru-in-kyoto-cabinet>Compare with LRU in Kyoto Cabinet</h5><p>So sánh với Kyoto Cabinet khi hiện thực LRU, Kyoto Cabinet lưu trữ hash table lẫn doubly linked list đều dùng các thư viện của C++ (<code>vector</code>, <code>unorderd_map</code>), đồng thời không sử dụng pointer để lưu các record, nên có thời gian kém hơn so với memcached, tốn <code>O(N)</code> cho các tác vụ update lại LRU (do cần duyệt trên linkedlist để tìm ra record tương ứng, trong khi memcached là pointer).</p><h5 id=segmented-lru-sub-lru>Segmented LRU (sub-LRU)</h5><p>Memcached chia LRU thành 4 tầng (gọi là sub-LRU) { HOT, WARM, COLD, TEMP }, thực hiện delay việc update lại item khi item được read. Mỗi sub có mutex lock riêng.</p><p>Mỗi item trong memcached có 2 bit thể hiện mức độ active của nó:</p><ul><li>FETCHED: nếu item được request 1 lần</li><li>ACTIVE: nếu item được accessed lần thứ 2.</li></ul><p>Các trạng thái của item:</p><div class="row-flex around around"><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/sub_lru-states.png alt width decoding=async></div><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/settings_03.png alt width decoding=async></div></div><p><strong>Descriptions</strong>:</p><table><thead><tr><th><strong>Field</strong></th><th><strong>Comments</strong></th></tr></thead><tbody><tr><td><strong>lru_crawler_sleep</strong></td><td>Microsecond sleep between items</td></tr><tr><td><strong>lru_crawler_tocrawl</strong></td><td>Number of items to crawl per run</td></tr><tr><td><strong>crawls_persleep</strong></td><td>Number of LRU crawls to run before sleeping</td></tr><tr><td><strong>hot_lru_pct</strong></td><td>percentage of slab space for HOT_LRU</td></tr><tr><td><strong>warm_lru_pct</strong></td><td>percentage of slab space for WARM_LRU</td></tr><tr><td><strong>hot_max_factor</strong></td><td>HOT tail age relative to COLD tail</td></tr><tr><td><strong>warm_max_factor</strong></td><td>WARM tail age relative to COLD tail</td></tr><tr><td><strong>temp_lru</strong></td><td>TTL &lt; temporary_ttl uses TEMP_LRU</td></tr><tr><td><strong>temporary_ttl</strong></td><td>temporary LRU threshold</td></tr></tbody></table><p><strong>HOT</strong>: nếu item tới threshold của HOT, sẽ bị moved sang WARM (<code>3</code>) hoặc COLD (<code>5</code>) tùy theo đang <em>ACTIVE</em> hay không.</p><p><strong>WARM</strong>: chỉ những items được accessed tối thiểu 2 lần mới có cơ hội nằm trong WARM. nếu item tới threshold của WARM sẽ được moved lên head của WARM (<code>4</code>) nếu đang <em>ACTIVE</em>, ngược lại bị đẩy xuống COLD (<code>7</code>)</p><p><strong>COLD</strong>: chứa các inative items, theo đường <code>5</code> với <code>7</code> từ HOT và WARM. Khi 1 item được active, nó sẽ được moved lên WARM (<code>6</code>)</p><p><strong>TEMP</strong>: chứa các item có TTL cực ngắn.</p><p>Trong khi alloc cho item, việc lựa chọn 1 sub-LRU dựa trên thời gian TTL của item đó có đủ lâu để đưa vào HOT không:</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/alloc_sub_lru.png alt width decoding=async></div><h5 id=lru-threads-in-segmented-lru>LRU Threads in segmented LRU</h5><p>Memcached sử dụng 2 threads để duy trì trạng thái LRU của các items, 1 là <code>lru maintainer</code> và 1 thread <code>lru cralwer</code></p><p><code>lru maintainer</code> thực hiện sắp xếp các items giữa các sub-lru (hot|warn|cold|temp)</p><p><code>lru cralwer</code> thực hiện đào thải các item expired hoặc invalid. Default thread này được start in background.</p><h6 id=lru-maintainer-thread>LRU Maintainer Thread</h6><p>Jobs:</p><ul><li>duyệt các sub-LRU, check các tail items</li><li>đảm bảo các sub-LRU work, thực hiện moved các items</li><li>reclaim các expired <em>tail</em> items</li></ul><h6 id=lru-crawler-thread>LRU Crawler Thread</h6><p>Giải quyết các items bị expired nhưng ko được accessed để evict. Chạy async để reclaim <em>tất cả</em> expired items.</p><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/lru_crawler.png alt width decoding=async></div><h4 id=external-storage>External Storage</h4><p>External Storage (<code>extstore</code>) là một mở rộng cho memcached, hash table và các keys được lưu trên memory, trong khi values được lưu trong bộ nhớ bên ngoài.</p><p><strong>When to use this?</strong></p><blockquote><p>If you only have one or two memcached instances, you probably don&rsquo;t need this.</p></blockquote><p>Khi values được lưu trữ có kích thước lớn và TTL đủ lớn, nên sử dụng extstore để tiết kiệm RAM trên cloud.</p><h5 id=implementation-1>Implementation</h5><p>So với khi không sử dụng external storage, extstore sử dụng 2 thread <code>storage</code> và <code>compactation</code>. Về chức năng:</p><ul><li><code>storage thread</code> tương tự <code>lru maintainer</code>, thực hiện check các tail items trên các slab class.</li><li><code>compactation thread</code> &mldr;</li></ul><p>Cách 1 tail item được đưa vào extstore:</p><ul><li>alloc new small item</li><li>lưu trữ các meta của item khi đc đưa ra extstore, gồm <code>page_version</code>, <code>offset</code> và <code>page_id</code></li><li>Thay thế value của item thành thông tin item trên hardware (<code>item_hdr</code>)</li></ul><div class="center m-t-20 m-b-20"><img src=/img/post/memcached/extstore_meta.png alt width decoding=async></div><p>Một số thông số quyết định item có được đưa ra external storage hay không: item đủ lớn, item exist lâu, item sống lâu:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> ext_item_size;  <span style=color:#75715e>/* minimum size of items to store externally */</span>
<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> ext_item_age;   <span style=color:#75715e>/* max age of tail item before storing ext. */</span>
<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> ext_low_ttl;    <span style=color:#75715e>/* remaining TTL below this uses own pages */</span>
</code></pre></div><p>Các giá trị default mặc định:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>settings.ext_item_size  <span style=color:#f92672>=</span> <span style=color:#ae81ff>512</span>;
settings.ext_item_age   <span style=color:#f92672>=</span> UINT_MAX; <span style=color:#75715e>// Maximum value an `unsigned int&#39; can hold
</span><span style=color:#75715e></span>settings.ext_low_ttl    <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</code></pre></div><p>Để đưa item ra external storage, cần item tối thiểu 512 bytes, đồng thời cần set <code>ext_item_age</code> đủ nhỏ (chờ cho age của item đủ lớn sẽ được flush ra ngoài storage).</p><p>Có thể start memcached instance như sau:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>memcached -p <span style=color:#ae81ff>11111</span> -o ext_item_age<span style=color:#f92672>=</span>1,ext_path<span style=color:#f92672>=</span>/home/abc/datafile:1G -vv
</code></pre></div><h2 id=references>References</h2><ul><li><a href=https://github.com/memcached/memcached/wiki>Memcached Wiki</a></li><li><a href=https://holmeshe.me/categories/Memcached-Source-Code/>Understanding The Memcached Source Code</a></li><li><a href=https://www.toptal.com/big-data/consistent-hashing>Consistent Hashing in Distributed Caches</a></li><li><a href=https://medium.com/@Alibaba_Cloud/redis-vs-memcached-in-memory-data-storage-systems-3395279b0941>Redis vs Memcached</a></li><li><a href=https://mahmudahsan.files.wordpress.com/2009/02/mysql_wp_memcached.pdf>Memcached vs MySQL</a></li><li><a href=https://memcached.org/blog/modern-lru/>Modern LRU in Memcached</a></li><li><a href=https://github.com/memcached/memcached/wiki/Extstore>External Storage in Memcached</a></li></ul></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/memcached/ rel=tag>Memcached</a></li><li class=tags__item><a class="tags__link btn" href=/tags/database/ rel=tag>Database</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Ha. Huynh Sam avatar" src=/img/avatar.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name></span></div><div class=authorbox__description>HaHS's true identity is unknown. Maybe he is a successful blogger or writer. Nobody knows it. Do you know him? Let me know that 😉.</div></div><nav class="post-nav flex"><div class="post-nav__item post-nav__item--prev"><a class=post-nav__link href=/post/tutorial/cloud/launch-amazon-ec2-instance-with-aws-free-tier-ubuntu-server-18/ rel=prev><span class=post-nav__caption>«&#8201;Previous</span><p class=post-nav__post-title>Launch Amazon EC2 Instance with AWS Free Tier - Ubuntu Server 18.04 LTS</p></a></div><div class="post-nav__item post-nav__item--next"><a class=post-nav__link href=/post/tutorial/java/basic/thread/singlethreaded-server-trong-java/ rel=next><span class=post-nav__caption>Next&#8201;»</span><p class=post-nav__post-title>Singlethreaded Server trong Java</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"wearenodev"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><aside class=sidebar><div class="post__toc toc toc_sidebar m-t-30 m-b-50"><div class=toc__title>Table of contents</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#overview>Overview</a><ul><li><a href=#features>Features</a></li><li><a href=#design-philosophy>Design Philosophy</a></li></ul></li><li><a href=#detail>Detail</a><ul><li><a href=#memcached-client>Memcached Client</a></li><li><a href=#memcached-server>Memcached Server</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/post/tutorial/database/build-thrift-service-on-top-of-rocksdb/>Build Thrift Service on top of RocksDB</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/security/tong-hop-top-10-loi-bao-mat-owasp-2017/>Tổng hợp top 10 lỗi bảo mật từ OWASP báo cáo năm 2017</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/network/tom-tat-su-khac-biet-giua-cac-version-cua-http-1.0-1.1-2.0/>Tóm tắt sự khác biệt giữa các version của HTTP 1.0, 1.1 và 2.0</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/elasticsearch/discord-da-thiet-lap-elasticsearch-ntn-de-index-hang-ty-messages/>Discord đã thiết lập Elasticsearch như thế nào để có thể index hàng tỷ messages?</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/elasticsearch/monitor-your-elasticsearch-cluster-with-grafana-and-prometheus/>Monitor your Elasitcsearch Cluster with Grafana and Prometheus</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/javascript/advance/vietnamese-search-in-datatables/>Tìm kiếm dữ liệu Tiếng Việt không dấu trong DataTables</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/cloud/>Cloud</a></li><li class=widget__item><a class=widget__link href=/categories/database/>Database</a></li><li class=widget__item><a class=widget__link href=/categories/elasticsearch/>Elasticsearch</a></li><li class=widget__item><a class=widget__link href=/categories/heroku/>Heroku</a></li><li class=widget__item><a class=widget__link href=/categories/java/>Java</a></li><li class=widget__item><a class=widget__link href=/categories/javascript/>JavaScript</a></li><li class=widget__item><a class=widget__link href=/categories/linux/>Linux</a></li><li class=widget__item><a class=widget__link href=/categories/network/>Network</a></li><li class=widget__item><a class=widget__link href=/categories/nodejs/>NodeJS</a></li><li class=widget__item><a class=widget__link href=/categories/security/>Security</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/adminlte2/ title=AdminLTE2>AdminLTE2 (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/aws/ title=AWS>AWS (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/aws-ec2/ title="AWS - EC2">AWS - EC2 (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/cloud/ title=Cloud>Cloud (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/database/ title=Database>Database (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/elasticsearch/ title=Elasticsearch>Elasticsearch (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/elasticsearch-monitoring/ title="Elasticsearch Monitoring">Elasticsearch Monitoring (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/google-apis/ title="Google APIs">Google APIs (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/grafana/ title=Grafana>Grafana (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/heroku-deployment/ title="Heroku Deployment">Heroku Deployment (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/http/ title=HTTP>HTTP (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java/ title=Java>Java (4)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java-basic/ title="Java Basic">Java Basic (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java-thread/ title="Java Thread">Java Thread (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/javascript/ title=JavaScript>JavaScript (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/javascript-advance/ title="JavaScript Advance">JavaScript Advance (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/jsrmvi/ title=jsrmvi>jsrmvi (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/linux/ title=Linux>Linux (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/memcached/ title=Memcached>Memcached (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mongodb/ title=MongoDB>MongoDB (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mongoose/ title=Mongoose>Mongoose (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/network/ title=Network>Network (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs/ title=NodeJS>NodeJS (5)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs-advance/ title="NodeJS Advance">NodeJS Advance (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs-deployment/ title="NodeJS Deployment">NodeJS Deployment (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/npm/ title=NPM>NPM (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/owasp/ title=OWASP>OWASP (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/pgadmin/ title=pgAdmin>pgAdmin (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/postgresql/ title=PostgreSQL>PostgreSQL (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/prometheus/ title=Prometheus>Prometheus (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/robomongo/ title=Robomongo>Robomongo (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/rocksdb/ title=RocksDB>RocksDB (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/security/ title=Security>Security (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/sequelize/ title=Sequelize>Sequelize (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/thrift/ title=Thrift>Thrift (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/ubuntu/ title=Ubuntu>Ubuntu (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/vietnamese/ title=Vietnamese>Vietnamese (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/vietnamese-search/ title="Vietnamese Search">Vietnamese Search (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/webpack/ title=Webpack>Webpack (1)</a></div></div><span class="widget-social widget m-b-15"><h4 class="widget-social__title widget__title">Social</h4><div class="widget-social__content widget__content"><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-github" title=GitHub rel="noopener noreferrer" href=https://github.com/WeAreNoDev target=_blank><i class="fa fa-github-square"></i></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-twitter" title=Twitter rel="noopener noreferrer" href=https://twitter.com/huynhsamha target=_blank><i class="fa fa-twitter-square"></i></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-email" title=Email href=mailto:huynhsamha@gmail.com><i class="fa fa-envelope-square"></i></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-linkedin" title=LinkedIn rel="noopener noreferrer" href=https://linkedin.com/in/huynhsamha target=_blank><i class="fa fa-linkedin-square"></i></a></span></div></span></aside></div><footer class=footer><div class="container footer__container"><div class=footer__copyright>WeAreNoDev &copy; 2020<div><span class=footer__copyright-credits>Made with<i class="fa fa-heart m-l-5 m-r-5" style=color:#eb0025></i>by
<a href=https://github.com/huynhsamha target=_blank>Ha. Huynh Sam</a></span></div></div></div></footer></div><span id=scroll-top><i class="fa fa-caret-up"></i></span><script src=/vendor/jquery/3.5.1/jquery.min.js></script><script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script><script type=text/javascript src=/js/main.min.f422027a0caaf9eadab59acbeb7e0d9a.js integrity="md5-9CICegyq+eratZrL634Nmg=="></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>