<!doctype html><html class=no-js lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#ffffff"><title>Build Thrift Service on top of RocksDB - We Are No Dev</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content="M√¨nh ƒë√£ build Thrift service (a RPC Framework) on top of RocksDB (an embeddable persistent key-value storage) nh∆∞ m·ªôt database s·ª≠ d·ª•ng cho m·ªôt s·ªë projects khi l√†m vi·ªác t·∫°i Zalo. Hi·ªáu nƒÉng m√† RocksDB c√πng v·ªõi Thrift mang l·∫°i k·∫øt qu·∫£ kh√° tuy·ªát v·ªùi v·ªõi kh·∫£ nƒÉng ƒë·ªçc ghi d·ªØ li·ªáu cao, ph√π h·ª£p s·ª≠ d·ª•ng cho c√°c tools m√¨nh th·ª±c hi·ªán t·∫°i Zalo khi kh√¥ng y√™u c·∫ßu s·ª≠ d·ª•ng DB n·ªôi b·ªô c·ªßa c√¥ng ty."><meta property="og:title" content="Build Thrift Service on top of RocksDB"><meta property="og:description" content="M√¨nh ƒë√£ build Thrift service (a RPC Framework) on top of RocksDB (an embeddable persistent key-value storage) nh∆∞ m·ªôt database s·ª≠ d·ª•ng cho m·ªôt s·ªë projects khi l√†m vi·ªác t·∫°i Zalo. Hi·ªáu nƒÉng m√† RocksDB c√πng v·ªõi Thrift mang l·∫°i k·∫øt qu·∫£ kh√° tuy·ªát v·ªùi v·ªõi kh·∫£ nƒÉng ƒë·ªçc ghi d·ªØ li·ªáu cao, ph√π h·ª£p s·ª≠ d·ª•ng cho c√°c tools m√¨nh th·ª±c hi·ªán t·∫°i Zalo khi kh√¥ng y√™u c·∫ßu s·ª≠ d·ª•ng DB n·ªôi b·ªô c·ªßa c√¥ng ty."><meta property="og:type" content="article"><meta property="og:url" content="/post/tutorial/database/build-thrift-service-on-top-of-rocksdb/"><meta property="article:published_time" content="2020-12-05T00:00:00+00:00"><meta property="article:modified_time" content="2020-12-05T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Build Thrift Service on top of RocksDB"><meta name=twitter:description content="M√¨nh ƒë√£ build Thrift service (a RPC Framework) on top of RocksDB (an embeddable persistent key-value storage) nh∆∞ m·ªôt database s·ª≠ d·ª•ng cho m·ªôt s·ªë projects khi l√†m vi·ªác t·∫°i Zalo. Hi·ªáu nƒÉng m√† RocksDB c√πng v·ªõi Thrift mang l·∫°i k·∫øt qu·∫£ kh√° tuy·ªát v·ªùi v·ªõi kh·∫£ nƒÉng ƒë·ªçc ghi d·ªØ li·ªáu cao, ph√π h·ª£p s·ª≠ d·ª•ng cho c√°c tools m√¨nh th·ª±c hi·ªán t·∫°i Zalo khi kh√¥ng y√™u c·∫ßu s·ª≠ d·ª•ng DB n·ªôi b·ªô c·ªßa c√¥ng ty."><link rel=icon type=image/png href=/favicon.png><link rel=apple-touch-icon href=/favicon.png><meta name=msapplication-TileImage content="/favicon.png"><link href="https://fonts.googleapis.com/css2?family=Muli:ital,wght@0,400;0,500;0,700;0,800;1,400&display=swap" rel=stylesheet><link href=/vendor/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet><link rel=stylesheet href=/css/style.min.3593336bd12106f4ab3d37ce2fd3db6b.css integrity="md5-NZMza9EhBvSrPTfOL9Pbaw=="><link rel=stylesheet href=/css/spacing_helpers.min.css><link rel=stylesheet href=/css/custom.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-162061519-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class=logo><a href=/ title="We Are No Dev" rel=home><img src=/favicon.png alt="We Are No Dev" class=header__favicon></a>
<a class=logo__link href=/ title="We Are No Dev" rel=home><div class=logo__title>We Are No Dev</div><div class=logo__tagline>We are NOT ONLY Developers</div></a><img src=/img/outline-banner.png alt="We Are No Dev" class=header__banner_img></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Build Thrift Service on top of RocksDB</h1><div class="post__meta meta"><div class="meta__item meta__item-lang"><i class=meta__icon><img src=/icon/vi64.png alt=vi width=16px></i>
<span class=meta__text>Vietnamese</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-12-05T00:00:00Z>Dec 05, 2020</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/database/ rel=category>Database</a></span></div></div></header><div class="post__toc toc toc_mobile"><div class=toc__title>Table of contents</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#1-overview>1. Overview</a><ul><li><a href=#11-rocksdb>1.1. RocksDB</a></li><li><a href=#12-thrift-service>1.2. Thrift Service</a></li></ul></li><li><a href=#2-implementation>2. Implementation</a><ul><li><a href=#21-partitions>2.1. Partitions</a></li><li><a href=#22-key-and-value-types>2.2. Key and Value Types</a></li><li><a href=#23-range-types>2.3. Range Types</a></li><li><a href=#24-map-types>2.4. Map Types</a></li><li><a href=#25-supported-apis>2.5. Supported APIs</a></li><li><a href=#26-thrift-client-wrapper>2.6. Thrift Client Wrapper</a></li></ul></li><li><a href=#3-benchmarking>3. Benchmarking</a></li><li><a href=#4-conclusion>4. Conclusion</a></li></ul></nav></div></div><div class="content post__content clearfix"><p>M√¨nh ƒë√£ build <a href=https://thrift.apache.org/>Thrift service</a> (<strong>a RPC Framework</strong>) on top of <a href=https://rocksdb.org/>RocksDB</a> (<strong>an embeddable persistent key-value storage</strong>) nh∆∞ m·ªôt database s·ª≠ d·ª•ng cho m·ªôt s·ªë projects khi l√†m vi·ªác t·∫°i <a href=https://zalo.careers/>Zalo</a>. Hi·ªáu nƒÉng m√† RocksDB c√πng v·ªõi Thrift mang l·∫°i k·∫øt qu·∫£ kh√° tuy·ªát v·ªùi v·ªõi <strong>kh·∫£ nƒÉng ƒë·ªçc ghi d·ªØ li·ªáu cao</strong>, ph√π h·ª£p s·ª≠ d·ª•ng cho c√°c tools m√¨nh th·ª±c hi·ªán t·∫°i Zalo khi kh√¥ng y√™u c·∫ßu s·ª≠ d·ª•ng DB n·ªôi b·ªô c·ªßa c√¥ng ty.</p><h2 id=1-overview>1. Overview</h2><p>Tr∆∞·ªõc h·∫øt, m√¨nh xin ƒë·ªÅ c·∫≠p ƒë·∫øn l√Ω do t·∫°i sao m√¨nh l·∫°i ch·ªçn <a href=https://rocksdb.org/>RocksDB</a> ƒë·ªÉ l√†m <em><strong>embeded database</strong></em> cho con Thrift service c·ªßa m√¨nh. Chuy·ªán l√† khi m√¨nh c√≤n trong giai ƒëo·∫°n Fresher t·∫°i Zalo, khi ƒë√≥ m√¨nh c√≥ task v·ªÅ vi·ªác tracking d·ªØ li·ªáu (d·ªØ li·ªáu g√¨ th√¨ m√¨nh kh√¥ng ti·ªán ƒë·ªÅ c·∫≠p), v·ªõi l∆∞·ª£ng d·ªØ li·ªáu kh√° cao (<strong>h∆°n 3000 req/s</strong>). R√µ r√†ng c√°c DB kh√°c nh∆∞ MySQL hay MongoDB kh√¥ng ƒë√°p ·ª©ng ƒë∆∞·ª£c nhu c·∫ßu n√†y. ƒê·ªëi v·ªõi Zalo, con DB n·ªôi b·ªô d∆∞ s·ª©c x·ª≠ l√Ω m·∫•y lo·∫°i n√†y, tuy nhi√™n do m√¨nh c√≤n l√† Fresher c≈©ng nh∆∞ task n√†y kh√¥ng qu√° quan tr·ªçng ƒë·ªëi v·ªõi c√¥ng ty n√™n m√¨nh kh√¥ng ƒë∆∞·ª£c c·∫•p c√°c DB n√†y. Th·∫ø l√† sau m·ªôt th·ªùi gian t√¨m ki·∫øm tr√™n Google, m√¨nh ƒë√£ t√¨m ƒë∆∞·ª£c <a href=https://rocksdb.org/>RocksDB</a>, m·ªôt con embbeded DB mang l·∫°i cho m√¨nh kh√° nhi·ªÅu tin t∆∞·ªüng, v√¨ l√† m·ªôt Open Source t·ª´ Facebook, forked ra t·ª´ <a href=https://github.com/google/leveldb>LevelDB</a> c·ªßa Google, c≈©ng nh∆∞ ƒë∆∞·ª£c s·ª≠ d·ª•ng l√†m innerDB (engine storage) trong m·ªôt v√†i con DB kh√°c.</p><p>C√≤n v·ªõi l√Ω do m√¨nh l·∫°i wrap con RocksDB trong m·ªôt Thrift Service v√¨</p><ul><li>Zalo ch·ªß y·∫øu s·ª≠ d·ª•ng Thrift l√†m RPC framework cho c√°c micro-services</li><li>Ph·ª•c v·ª• kh·∫£ nƒÉng ƒë·ªçc ghi t·ª´ nhi·ªÅu service kh√°c, ch·ª© RocksDB l√† in-process DB (ch·ªâ 1 process c√≥ th·ªÉ write tr√™n DB n√†y)</li></ul><h3 id=11-rocksdb>1.1. RocksDB</h3><div class="center m-t-20 m-b-20"><img src=https://i.imgur.com/KxONoMD.jpg alt width=400px decoding=async></div><p>Gi·ªõi thi·ªáu ng·∫Øn g·ªçn qua v·ªÅ <strong>RocksDB</strong></p><ul><li>M·ªôt <strong>key-value</strong> storage</li><li>S·ª≠ d·ª•ng <strong>Log Structured Database Engine</strong></li><li>Hi·ªán th·ª±c b·∫±ng <strong>C++</strong></li><li>H·ªó tr·ª£ <strong>JNI</strong> - <strong>Java Wrapper</strong></li><li>H·ªó tr·ª£ <a href=https://github.com/facebook/rocksdb/wiki/Column-Families>Column-Family</a> cho vi·ªác <strong>partition</strong> d·ªØ li·ªáu trong 1 process</li><li>Key ƒë∆∞·ª£c <strong>sort</strong> trong l∆∞u tr·ªØ, c√≥ th·ªÉ <strong>prefix seek key</strong>, <strong>iterate theo key</strong>.</li></ul><p>RocksDB cung c·∫•p t√†i li·ªáu tr√™n <a href=https://github.com/facebook/rocksdb/wiki/Basic-Operations>Github</a> v·ªÅ c√°ch hi·ªán th·ª±c, l∆∞u tr·ªØ v√† s·ª≠ d·ª•ng. C√°c b·∫°n c√≥ th·ªÉ (n√™n) ƒë·ªçc v·ªÅ lo·∫°i DB n√†y n·∫øu th·ª±c s·ª± mu·ªën s·ª≠ d·ª•ng n√≥.</p><h3 id=12-thrift-service>1.2. Thrift Service</h3><p><a href=https://thrift.apache.org/>Apache Thrift</a> l√† m·ªôt <strong>RPC framework</strong>, cho c√°c <strong>mircro-services</strong> t∆∞∆°ng t√°c v·ªõi nhau v·ªõi kh·∫£ nƒÉng <strong>cross-language</strong>, t·ª©c c√°c ng√¥n ng·ªØ kh√°c nhau c√≥ th·ªÉ g·ªçi m√† kh√¥ng th√¥ng c·∫ßn c√°c protocol m·ª©c cao h∆°n (HTTP c≈©ng l√† m·ªôt protocol cho ph√©p c√°c ng√¥n ng·ªØ kh√°c nhau c√≥ th·ªÉ giao ti·∫øp, nh∆∞ng s·ª≠ d·ª•ng JSON nh∆∞ c·∫ßu n·ªëi cho c√°c ng√¥n ng·ªØ n√†y). Ngo√†i ra Thrift c√≤n cho ph√©p <strong>code generation</strong>, t·∫°o nhi·ªÅu thu·∫≠n ti·ªán khi l√†m vi·ªác tr√™n nhi·ªÅu ng√¥n ng·ªØ.</p><p>T·∫°i Zalo, Thrift ƒë∆∞·ª£c s·ª≠ d·ª•ng kh√° nhi·ªÅu v√† ph·ªï bi·∫øn, v√† c≈©ng ƒë√£ ƒë∆∞·ª£c <em>custom</em>, <em>build s·∫µn</em> r·∫•t nhi·ªÅu <em>lib n·ªôi b·ªô</em> v√† <em>config t·ªëi ∆∞u</em>, t·ª´ <strong>thrift server</strong> cho ƒë·∫øn <strong>thrift client</strong> (hay c√≤n g·ªçi l√† <strong>wrapper</strong>, cho ph√©p b·∫•t k√¨ service n√†o c≈©ng c√≥ th·ªÉ g·ªçi ƒë·∫øn c√°c thrift server). Trong b√†i vi·∫øt n√†y, m√¨nh c≈©ng d·ª±a tr√™n Thrift t·∫°i Zalo ƒë·ªÉ build 1 Thrift server wrap l·∫°i con RocksDB v√† b·ªô Thrift client (client wrapper) ph·ª•c v·ª• v√† h·ªó tr·ª£ nhi·ªÅu lo·∫°i cho con server c·ªßa m√¨nh.</p><h2 id=2-implementation>2. Implementation</h2><p>Do m√¨nh ƒë√£ hi·ªán th·ª±c build d·ª±a tr√™n Thrift ƒë√£ custom c·ªßa Zalo n√™n m√¨nh kh√¥ng th·ªÉ share c≈©ng nh∆∞ public ƒë∆∞·ª£c c·∫£ thrift server v√† thrift client, tuy nhi√™n m√¨nh c√≥ th·ªÉ chia s·∫ª v·ªÅ nh·ªØng g√¨ m√¨nh ƒë√£ hi·ªán th·ª±c.</p><p>Nh∆∞ m√¨nh ƒë√£ ƒë·ªÅ c·∫≠p, RocksDB h·ªó tr·ª£ JNI hay Java Wrapper, do ƒë√≥ cho ph√©p ta d·ªÖ d√†ng build m·ªôt Thrift service b·∫±ng Java (do m√¨nh ch·ªß y·∫øu l√†m vi·ªác v·ªõi <strong>Java</strong> v√† s·ª≠ d·ª•ng c√°c <strong>tool profiler</strong> t·∫°i Zalo). V·ªÅ Java Wrapper m√† RocksDB cnug c·∫•p, m√¨nh xin ƒë·ªÉ l·∫°i <a href=https://github.com/facebook/rocksdb/wiki/RocksJava-Basics>link t·∫°i ƒë√¢y</a>.</p><p>M√¥ h√¨nh s·∫Ω ƒë∆∞·ª£c th·ªÉ hi·ªán nh∆∞ h√¨nh sau, trong ƒë√≥ thrift server s·∫Ω <strong>m·ªü 2 port,</strong> <strong>1 port config</strong>, <strong>1 port read/write</strong>, v·ªõi <strong>ph√¢n quy·ªÅn</strong> <strong>read/write/config</strong> cho c√°c clients g·ªçi v√†o.</p><div class="center m-t-20 m-b-20"><img src=/img/post/rocksdb/Thrift-RocksDB.png alt="Thrift RocksDB" width=100% decoding=async></div><h3 id=21-partitions>2.1. Partitions</h3><p>V·∫•n ƒë·ªÅ ƒë·∫ßu ti√™n m√† ch√∫ng ta c·∫ßn l∆∞u √Ω ·ªü RocksDB ch√≠nh l√† h·ªó tr·ª£ <a href=https://github.com/facebook/rocksdb/wiki/Column-Families>Column-Family</a>, kh·∫£ nƒÉng ph√¢n t√°ch t·∫≠p DB ra nhi·ªÅu lo·∫°i, c√≥ th·ªÉ h√¨nh dung nh∆∞ tables trong SQL hay collections trong MongoDB.</p><p>Do ƒë√≥ trong Thrift service m√¨nh d·ª± ƒë·ªãnh build c≈©ng c·∫ßn h·ªó tr·ª£ vi·ªác partition n√†y. C√°c partition m√¨nh ƒë·ªÉ gi√° tr·ªã <code>integer</code> hay <code>i32</code> trong Thrift</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>typedef</span> i32    TPartition
</code></pre></div><h3 id=22-key-and-value-types>2.2. Key and Value Types</h3><p>Trong RocksDB, key v√† value l√† d·ªØ li·ªáu binary, do ƒë√≥ trong Thrift t∆∞∆°ng ·ª©ng c≈©ng l√† <code>binary</code> (hay <code>ByteBuffer</code> trong Java)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>typedef</span> binary TKey
<span style=color:#66d9ef>typedef</span> binary TValue
</code></pre></div><p>M√¨nh ƒë·ªãnh nghƒ©a th√™m c√°c structs d∆∞·ªõi ƒë√¢y cho vi·ªác ƒë·ªãnh danh d·ªØ li·ªáu d·ªÖ d√†ng, ph·ª•c v·ª• cho multiget, map result, &mldr; Trong ƒë√≥ <code>master</code> ƒë∆∞·ª£c ƒë√≠nh k√®m th√™m ph√¢n v√πng m√† key-value n·∫±m tr√™n RocksDB</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>TMasterKey</span> {
    <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>required TPartition partition,
    <span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>required TKey key,
}

<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>TData</span> {
	<span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>required TKey key,
	<span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>required TValue value,
}

<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>TMasterData</span> {
	<span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>required TPartition partition,
	<span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>required TKey key,
	<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>required TValue value,
}
</code></pre></div><h3 id=23-range-types>2.3. Range Types</h3><p>Nh∆∞ m√¨nh ƒë√£ ƒë·ªÅ c·∫≠p, RocksDB h·ªó tr·ª£ iterate theo t·∫≠p key, do ƒë√≥ m·ªôt ki·ªÉu d·ªØ li·ªáu c·∫ßn h·ªó tr·ª£ l√† list theo key v√† list theo data (key-value) nh∆∞ sau</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>typedef</span> list<span style=color:#f92672>&lt;</span>TKey<span style=color:#f92672>&gt;</span> TListKey
<span style=color:#66d9ef>typedef</span> list<span style=color:#f92672>&lt;</span>TValue<span style=color:#f92672>&gt;</span> TListValue
<span style=color:#66d9ef>typedef</span> list<span style=color:#f92672>&lt;</span>TData<span style=color:#f92672>&gt;</span> TListData

<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>TKeyRangeResult</span> {
	<span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>required i32 error,
	<span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>optional i32 offset, <span style=color:#75715e>// offset from seek key
</span><span style=color:#75715e></span>	<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>optional i32 total, <span style=color:#75715e>// total keys in result
</span><span style=color:#75715e></span>	<span style=color:#ae81ff>4</span><span style=color:#f92672>:</span>optional TListKey keys, <span style=color:#75715e>// list keys are iterated
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>TDataRangeResult</span> {
	<span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>required i32 error,
	<span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>optional i32 offset, <span style=color:#75715e>// offset from seek key
</span><span style=color:#75715e></span>	<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>optional i32 total, <span style=color:#75715e>// total keys in result
</span><span style=color:#75715e></span>	<span style=color:#ae81ff>4</span><span style=color:#f92672>:</span>optional TListData data, <span style=color:#75715e>// list key-value are iterated
</span><span style=color:#75715e></span>}
</code></pre></div><h3 id=24-map-types>2.4. Map Types</h3><p>RocksDB c≈©ng h·ªô tr·ª£ multiget theo key, do ƒë√≥ ta c·∫ßn ki·ªÉu map theo key</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>typedef</span> map<span style=color:#f92672>&lt;</span>TMasterKey, TValue<span style=color:#f92672>&gt;</span> TMapData
<span style=color:#66d9ef>typedef</span> map<span style=color:#f92672>&lt;</span>TMasterKey, i32<span style=color:#f92672>&gt;</span> TMapError

<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>TMapDataResult</span> {
	<span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>required i32 error, <span style=color:#75715e>// last error, useful to check if all data are retrieved successfully or not
</span><span style=color:#75715e></span>	<span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>optional map<span style=color:#f92672>&lt;</span>TKey, TValue<span style=color:#f92672>&gt;</span> dataMap,
	<span style=color:#ae81ff>3</span><span style=color:#f92672>:</span>optional map<span style=color:#f92672>&lt;</span>TKey, i32<span style=color:#f92672>&gt;</span> errorMap, <span style=color:#75715e>// for check error of any fail data
</span><span style=color:#75715e></span>}
</code></pre></div><h3 id=25-supported-apis>2.5. Supported APIs</h3><p>C√°c APIs thrift m√¨nh h·ªó tr·ª£ d∆∞a tr√™n RocksDB h·ªó tr·ª£ g·ªìm (m√¨nh ch·ªâ ghi t∆∞·ª£ng tr∆∞ng, kh√¥ng ƒë√∫ng syntax trong thrift)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp>service ZRocksDBService {

	exist(TPartition, TKey)
	get(TPartition, TKey)

	<span style=color:#75715e>// multi get by key
</span><span style=color:#75715e></span>	multiGet(TPartition, TListKey)

	<span style=color:#75715e>// iterate by key
</span><span style=color:#75715e></span>	scanKey(TPartition, TKey seekKey, offset, limit)
	scan(TPartition, TKey seekKey, offset, limit)
	
	<span style=color:#75715e>// RocksDB: flush to disk
</span><span style=color:#75715e></span>	syn_put(TPartition, TKey, TValue, PutPolicy add_or_update)
	syn_remove(TPartition, TKey)
	syn_removeRange(TPartition, TKey beginKey, TKey endKey)
	
	<span style=color:#75715e>// RocksDB: async
</span><span style=color:#75715e></span>	put(TPartition, TKey, TValue, PutPolicy add_or_update)
	remove(TPartition, TKey)
	removeRange(TPartition, TKey beginKey, TKey endKey)

	<span style=color:#75715e>// one-way in Thrift
</span><span style=color:#75715e></span>	ow_put(TPartition, TKey, TValue, PutPolicy add_or_update)
	ow_remove(TPartition, TKey)
	ow_removeRange(TPartition, TKey beginKey, TKey endKey)

	<span style=color:#75715e>// config service
</span><span style=color:#75715e></span>	backup(TBackupOptionParam)
}
</code></pre></div><p>Vi·ªác hi·ªán th·ª±c chi ti·∫øt con server m√¨nh s·∫Ω kh√¥ng public ·ªü ƒë√¢y, tuy nhi√™n cƒÉn b·∫£n l√† g·ªçi c√°c API t·ª´ RocksDB ƒë√£ build s·∫µn.</p><h3 id=26-thrift-client-wrapper>2.6. Thrift Client Wrapper</h3><p>ƒê·ªëi v·ªõi Thrift client cho vi·ªác g·ªçi sang con thrift server, m√¨nh s·∫Ω h·ªó tr·ª£ t·∫≠n rƒÉng c√°c APIs build s·∫µn, cho ph√©p <strong>define key-value types</strong>, ph√¢n v√πng partition ƒë·ªÉ d·ªÖ d√†ng s·ª≠ d·ª•ng c√°c client n√†y, kh√¥ng c·∫ßn tr·∫£i qua c√°c b∆∞·ªõc <strong>serialize/deserialize</strong> c·ª•c <code>binary</code> t·ª´ <em>key/value</em>. Vi·ªác n√†y c≈©ng kh√° d·ªÖ d√†ng.</p><h2 id=3-benchmarking>3. Benchmarking</h2><p>M√¨nh ƒë√£ th·ª≠ benchmark cho <strong>kh·∫£ nƒÉng ƒë·ªçc/ghi</strong> d·ªØ li·ªáu c·ªßa con Thrift server</p><ul><li><strong>Server</strong>: <code>24</code> CPUs, RAM <code>128GB</code></li><li><strong>Clients</strong>: <code>3</code> nodes, m·ªói node <code>8</code> CPUs, RAM <code>8G</code></li></ul><p>M·ªói client nodes m√¨nh th·ª±c hi·ªán <strong>3 java process</strong>, m·ªói process l√† m·ªôt client g·ªçi sang server:</p><ul><li><strong>Put 4000 req/s</strong></li><li><strong>Get 4000 req/s</strong></li></ul><p>Server m√¨nh profiler ƒë∆∞·ª£c th√¨ ho√†n to√†n c√≥ th·ªÉ x·ª≠ l√Ω ƒë·ªìng th·ªùi <strong>put 36K req/s</strong> v√† <strong>get 36K req/s</strong>.</p><p>M√¨nh nh·∫≠n ra <strong>gi·ªõi h·∫°n n√†y l√† do ph√≠a client</strong> kh√¥ng th·ªÉ x·ª≠ l√Ω h∆°n ƒë∆∞·ª£c n·ªØa, do c·∫•u h√¨nh t∆∞∆°ng ƒë·ªëi, n·∫øu c√≥ th√™m client node, m√¨nh c√≥ th·ªÉ d·ªÖ d√†ng scale ra ƒë·ªÉ tƒÉng req/s n√†y l√™n m·ª©c cao h∆°n. Tuy nhi√™n kh·∫£ nƒÉng nh∆∞ tr√™n c≈©ng ƒë√£ cho m√¨nh k·∫øt qu·∫£ kh√° ƒë·∫πp :D.</p><h2 id=4-conclusion>4. Conclusion</h2><p>T√∫m l·∫°i m√¨nh ƒë√£ build th√†nh c√¥ng <strong>m·ªôt con Thrift service tr√™n RocksDB</strong>, c√≥ th·ªÉ s·ª≠ d·ª•ng r·ªông ra cho nhi·ªÅu d·ª± √°n nh·ªè kh√°c, d·ªÖ d√†ng cho ph√©p nhi·ªÅu b√™n truy c·∫≠p v√† x·ª≠ l√Ω d·ªØ li·ªáu th√¥ng qua con thrift n√†y.</p><p>M√¨nh c≈©ng ƒë√£ benchmark v·ªÅ hi·ªáu nƒÉng tr√™n m·ªôt con server t∆∞∆°ng ƒë·ªëi m·∫°nh, cho k·∫øt qu·∫£ <strong>put 36K req/s</strong> v√† <strong>get 36K req/s</strong> r·∫•t chi l√† kh·∫£ quan.</p><p><strong>C√°c v·∫•n ƒë·ªÅ</strong> kh√°c m√¨nh c√≤n v∆∞·ªõng ph·∫£i v√† c·∫ßn ph√°t tri·ªÉn h∆°n</p><ul><li>L√†m th·∫ø n√†o ƒë·ªÉ <strong>scale</strong> 1 node ra nhi·ªÅu nodes nh∆∞ m·ªôt <strong>cluster DB</strong>?</li><li><strong>Time-to-live</strong> cho DB, l√†m th·∫ø n√†o ƒë·ªÉ roll d·ªØ li·ªáu kh√¥ng d√πng n·ªØa.</li><li>C·∫£i thi·ªán performance c·ªßa DB khi th·ª±c hi·ªán <strong>delete</strong></li><li>T√°ch r·ªùi Thrift v√† tool profiler c·ªßa Zalo ƒë·ªÉ c√≥ th·ªÉ <strong>public source</strong> cho m·ªçi ng∆∞·ªùi ph√°t tri·ªÉn v√† s·ª≠ d·ª•ng.</li></ul><p>C·∫£m ∆°n c√°c b·∫°n ƒë√£ ƒë·ªçc ƒë·∫øn d√≤ng n√†y c·ªßa b√†i vi·∫øt n√†y. N·∫øu c√°c b·∫°n c√≥ th·∫Øc m·∫Øc g√¨ th√¨ c√≥ th·ªÉ li√™n h·ªá m√¨nh ho·∫∑c feedback trong khung chat d∆∞·ªõi ƒë√¢y ƒë·ªÉ c√≥ th·ªÉ d·ªÖ d√†ng trao ƒë·ªïi v√† ph√°t tri·ªÉn nhi·ªÅu h∆°n.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/rocksdb/ rel=tag>RocksDB</a></li><li class=tags__item><a class="tags__link btn" href=/tags/thrift/ rel=tag>Thrift</a></li><li class=tags__item><a class="tags__link btn" href=/tags/java/ rel=tag>Java</a></li><li class=tags__item><a class="tags__link btn" href=/tags/database/ rel=tag>Database</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Ha. Huynh Sam avatar" src=/img/avatar.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name></span></div><div class=authorbox__description>HaHS's true identity is unknown. Maybe he is a successful blogger or writer. Nobody knows it. Do you know him? Let me know that üòâ.</div></div><nav class="post-nav flex"><div class="post-nav__item post-nav__item--prev"><a class=post-nav__link href=/post/tutorial/security/tong-hop-top-10-loi-bao-mat-owasp-2017/ rel=prev><span class=post-nav__caption>¬´&#8201;Previous</span><p class=post-nav__post-title>T·ªïng h·ª£p top 10 l·ªói b·∫£o m·∫≠t t·ª´ OWASP b√°o c√°o nƒÉm 2017</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"wearenodev"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><aside class=sidebar><div class="post__toc toc toc_sidebar m-t-30 m-b-50"><div class=toc__title>Table of contents</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#1-overview>1. Overview</a><ul><li><a href=#11-rocksdb>1.1. RocksDB</a></li><li><a href=#12-thrift-service>1.2. Thrift Service</a></li></ul></li><li><a href=#2-implementation>2. Implementation</a><ul><li><a href=#21-partitions>2.1. Partitions</a></li><li><a href=#22-key-and-value-types>2.2. Key and Value Types</a></li><li><a href=#23-range-types>2.3. Range Types</a></li><li><a href=#24-map-types>2.4. Map Types</a></li><li><a href=#25-supported-apis>2.5. Supported APIs</a></li><li><a href=#26-thrift-client-wrapper>2.6. Thrift Client Wrapper</a></li></ul></li><li><a href=#3-benchmarking>3. Benchmarking</a></li><li><a href=#4-conclusion>4. Conclusion</a></li></ul></nav></div></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/post/tutorial/database/build-thrift-service-on-top-of-rocksdb/>Build Thrift Service on top of RocksDB</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/security/tong-hop-top-10-loi-bao-mat-owasp-2017/>T·ªïng h·ª£p top 10 l·ªói b·∫£o m·∫≠t t·ª´ OWASP b√°o c√°o nƒÉm 2017</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/network/tom-tat-su-khac-biet-giua-cac-version-cua-http-1.0-1.1-2.0/>T√≥m t·∫Øt s·ª± kh√°c bi·ªát gi·ªØa c√°c version c·ªßa HTTP 1.0, 1.1 v√† 2.0</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/elasticsearch/discord-da-thiet-lap-elasticsearch-ntn-de-index-hang-ty-messages/>Discord ƒë√£ thi·∫øt l·∫≠p Elasticsearch nh∆∞ th·∫ø n√†o ƒë·ªÉ c√≥ th·ªÉ index h√†ng t·ª∑ messages?</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/elasticsearch/monitor-your-elasticsearch-cluster-with-grafana-and-prometheus/>Monitor your Elasitcsearch Cluster with Grafana and Prometheus</a></li><li class=widget__item><a class=widget__link href=/post/tutorial/javascript/advance/vietnamese-search-in-datatables/>T√¨m ki·∫øm d·ªØ li·ªáu Ti·∫øng Vi·ªát kh√¥ng d·∫•u trong DataTables</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/cloud/>Cloud</a></li><li class=widget__item><a class=widget__link href=/categories/database/>Database</a></li><li class=widget__item><a class=widget__link href=/categories/elasticsearch/>Elasticsearch</a></li><li class=widget__item><a class=widget__link href=/categories/heroku/>Heroku</a></li><li class=widget__item><a class=widget__link href=/categories/java/>Java</a></li><li class=widget__item><a class=widget__link href=/categories/javascript/>JavaScript</a></li><li class=widget__item><a class=widget__link href=/categories/linux/>Linux</a></li><li class=widget__item><a class=widget__link href=/categories/network/>Network</a></li><li class=widget__item><a class=widget__link href=/categories/nodejs/>NodeJS</a></li><li class=widget__item><a class=widget__link href=/categories/security/>Security</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/adminlte2/ title=AdminLTE2>AdminLTE2 (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/aws/ title=AWS>AWS (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/aws-ec2/ title="AWS - EC2">AWS - EC2 (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/cloud/ title=Cloud>Cloud (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/database/ title=Database>Database (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/elasticsearch/ title=Elasticsearch>Elasticsearch (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/elasticsearch-monitoring/ title="Elasticsearch Monitoring">Elasticsearch Monitoring (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/google-apis/ title="Google APIs">Google APIs (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/grafana/ title=Grafana>Grafana (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/heroku-deployment/ title="Heroku Deployment">Heroku Deployment (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/http/ title=HTTP>HTTP (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java/ title=Java>Java (4)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java-basic/ title="Java Basic">Java Basic (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java-thread/ title="Java Thread">Java Thread (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/javascript/ title=JavaScript>JavaScript (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/javascript-advance/ title="JavaScript Advance">JavaScript Advance (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/jsrmvi/ title=jsrmvi>jsrmvi (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/linux/ title=Linux>Linux (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/memcached/ title=Memcached>Memcached (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mongodb/ title=MongoDB>MongoDB (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mongoose/ title=Mongoose>Mongoose (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/network/ title=Network>Network (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs/ title=NodeJS>NodeJS (5)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs-advance/ title="NodeJS Advance">NodeJS Advance (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/nodejs-deployment/ title="NodeJS Deployment">NodeJS Deployment (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/npm/ title=NPM>NPM (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/owasp/ title=OWASP>OWASP (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/pgadmin/ title=pgAdmin>pgAdmin (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/postgresql/ title=PostgreSQL>PostgreSQL (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/prometheus/ title=Prometheus>Prometheus (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/robomongo/ title=Robomongo>Robomongo (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/rocksdb/ title=RocksDB>RocksDB (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/security/ title=Security>Security (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/sequelize/ title=Sequelize>Sequelize (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/thrift/ title=Thrift>Thrift (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/ubuntu/ title=Ubuntu>Ubuntu (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/vietnamese/ title=Vietnamese>Vietnamese (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/vietnamese-search/ title="Vietnamese Search">Vietnamese Search (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/webpack/ title=Webpack>Webpack (1)</a></div></div><span class="widget-social widget m-b-15"><h4 class="widget-social__title widget__title">Social</h4><div class="widget-social__content widget__content"><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-github" title=GitHub rel="noopener noreferrer" href=https://github.com/WeAreNoDev target=_blank><i class="fa fa-github-square"></i></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-twitter" title=Twitter rel="noopener noreferrer" href=https://twitter.com/huynhsamha target=_blank><i class="fa fa-twitter-square"></i></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-email" title=Email href=mailto:huynhsamha@gmail.com><i class="fa fa-envelope-square"></i></a></span><span class="widget-social__item widget__item"><a class="widget-social__link widget__link btn btn-social-linkedin" title=LinkedIn rel="noopener noreferrer" href=https://linkedin.com/in/huynhsamha target=_blank><i class="fa fa-linkedin-square"></i></a></span></div></span></aside></div><footer class=footer><div class="container footer__container"><div class=footer__copyright>WeAreNoDev &copy; 2020<div><span class=footer__copyright-credits>Made with<i class="fa fa-heart m-l-5 m-r-5" style=color:#eb0025></i>by
<a href=https://github.com/huynhsamha target=_blank>Ha. Huynh Sam</a></span></div></div></div></footer></div><span id=scroll-top><i class="fa fa-caret-up"></i></span><script src=/vendor/jquery/3.5.1/jquery.min.js></script><script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script><script type=text/javascript src=/js/main.min.f422027a0caaf9eadab59acbeb7e0d9a.js integrity="md5-9CICegyq+eratZrL634Nmg=="></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>